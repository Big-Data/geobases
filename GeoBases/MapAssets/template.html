<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
    <head>
        <title>Map of "{{file_name}}"</title>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js"></script>
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
        <script type="text/javascript">

function initialize(jsonData) {

    // Set map options
    var parisLocation = new google.maps.LatLng(48.8, 2.33);

    var mapOptions = {
        zoom      : 2,
        center    : parisLocation,
        mapTypeId : google.maps.MapTypeId.ROADMAP
    };

    // Create the map
    var map = new google.maps.Map(
        document.getElementById("map_canvas"),
        mapOptions
    );

    var n = jsonData.length;

    var best_icon = n < 100 ? 'blue_marker.png' : 'blue_point.png';

    var markersArray = [];
    var i, e, position, marker;
    var infowindow = new google.maps.InfoWindow();

    // Load the data
    for (i=0 ; i<n ; i++) {

        e = jsonData[i];

        position = new google.maps.LatLng(e.lat, e.lng);

        marker = new google.maps.Marker({
            map         : map,
            position    : position,
            //animation   : google.maps.Animation.DROP,
            title       : e.label,
            icon        : best_icon,
            clickable   : true,
            draggable   : false
        });

        marker.help = ' ' +
        '<div class="infowindow">' +
            '<h3>' + e.label + '</h3>' +
            '<table cellpadding="1">' +
                '<tr><td><b>Key</b></td><td>' + e.key + '</td></tr>' +
                '<tr><td><b>Lat</b></td><td>' + e.lat + '</td></tr>' +
                '<tr><td><b>Lng</b></td><td>' + e.lng + '</td></tr>' +
            '</table>' +
        '</div>';

        google.maps.event.addListener(marker, 'click', function() {
            //infowindow.close(map, this);
            infowindow.setContent(this.help);
            infowindow.open(map, this);
        });

        // Saving marker
        markersArray.push(marker);

    }

    // Fit the bounds
    var bounds = new google.maps.LatLngBounds();
    var empty = true;
    var i, c;

    for (i=0, c=markersArray.length; i<c; i++) {

        if (markersArray[i].getMap() !== null) {
            bounds.extend(markersArray[i].getPosition());
            empty = false;
        }
    }

    if (! empty) {
        // If bound is empty, we avoid a big
        // drift to the pacific ocean :)
        map.fitBounds(bounds);
    }

}

$(document).ready(function() {

    $("#map_canvas").css({
        "height": $(window).height()*0.90
    });

    $("#map_canvas").css({
        "width": $(window).width()*0.99
    });

    $.getJSON(
        '{{json_file}}',
        function(data){
            initialize(data);
        }
    );

});

        </script>
    </head>

    <body>
        <div id="map_canvas" style="width:1000px; height:700px"></div>
    </body>
</html>
