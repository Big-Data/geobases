<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" >
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="{{file_name}}" content="{{file_name}}" />

        <title>Map of "{{file_name}}"</title>
    </head>

    <body>
        <div id="canvas" style="width:1000px; height:700px">
        </div>

        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js"></script>
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
        <script type="text/javascript">
<!--
if (!String.fmt) {
    String.prototype.fmt = function() {
        var formatted = this;
        var i;
        for (i=0; i<arguments.length; i++) {
            var regexp = new RegExp('\\{'+i+'\\}', 'gi');
            formatted = formatted.replace(regexp, arguments[i]);
        }
        return formatted;
    };
}


function overflow(text) {

    if (typeof text === "number") {
        return text;
    }

    if (text.length < 30) {
        return text;
    }

    return ('' + text).slice(0, 25) + '...';

}


function initialize(jsonData) {

    // Set map options
    var parisLocation = new google.maps.LatLng(48.8, 2.33);

    var mapOptions = {
        zoom      : 2,
        center    : parisLocation,
        mapTypeId : google.maps.MapTypeId.ROADMAP
    };

    // Create the map
    var map = new google.maps.Map(
        document.getElementById("canvas"),
        mapOptions
    );

    // Computing fields order
    var fields = [];
    var field;
    for (field in jsonData[0]) {
        if (jsonData[0].hasOwnProperty(field) && field !== '__lab__') {
            fields.push(field);
        }
    }

    fields.sort(function(a, b) {
        return b.toLowerCase() < a.toLowerCase();
    })

    var f = fields.length;
    var n = jsonData.length;

    var best_icon = n < 100 ? 'blue_marker.png' : 'blue_point.png';

    var markersArray = [];
    var i, j, e, latlng, marker;
    var infowindow = new google.maps.InfoWindow();

    // Load the data
    for (i=0 ; i<n ; i++) {

        e = jsonData[i];

        latlng = new google.maps.LatLng(e.lat, e.lng);

        if (isNaN(latlng.lat()) || isNaN(latlng.lng())) {
            //console.log(e.__lab__ + ' had no position: ' + e.lat + e.lng)
            continue;
        }

        marker = new google.maps.Marker({
            map         : map,
            position    : latlng,
            //animation   : google.maps.Animation.DROP,
            title       : e.__lab__,
            icon        : best_icon,
            clickable   : true,
            draggable   : false
        });

        marker.help = ' ' +
        '<div class="infowindow" style="min-width:400px; max-height:300px; overflow-y:auto;">' +
            '<h3>{0}</h3>'.fmt(e.__lab__) +
            '<table cellpadding="1">';

        for (j=0 ; j<f ; j++) {
            field = fields[j];
            marker.help += '<tr><td><i>{0}</i></td><td>{1}</td></tr>'.fmt(field, overflow(e[field]));
        }

        marker.help += ' ' +
            '</table>' +
        '</div>';

        google.maps.event.addListener(marker, 'click', function() {
            //infowindow.close(map, this);
            infowindow.setContent(this.help);
            infowindow.open(map, this);
        });

        // Saving marker
        markersArray.push(marker);

    }

    // Fit the bounds
    var bounds   = new google.maps.LatLngBounds();
    var nbPoints = 0;
    var i, c;

    for (i=0, c=markersArray.length; i<c; i++) {

        if (markersArray[i].getMap() !== null) {
            bounds.extend(markersArray[i].getPosition());
            nbPoints += 1;
        }
    }

    if (nbPoints >= 2) {
        // If bound is nbPoints, we avoid a big
        // drift to the pacific ocean :)
        map.fitBounds(bounds);
    }

}

$(document).ready(function() {

    $("#canvas").css({
        "height": $(window).height()*0.90
    });

    $("#canvas").css({
        "width": $(window).width()*0.99
    });

    $.getJSON(
        '{{json_file}}',
        function(data){
            initialize(data);
        }
    );

});
-->
        </script>
    </body>
</html>

