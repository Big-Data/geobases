

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>GeoBaseMain &mdash; GeoBases 4 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="GeoBases 4 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">GeoBases 4 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for GeoBaseMain</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/python</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module is a launcher for GeoBase.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">pkg_resources</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span><span class="p">,</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">izip_longest</span><span class="p">,</span> <span class="n">chain</span>
<span class="kn">import</span> <span class="nn">fcntl</span><span class="o">,</span> <span class="nn">termios</span><span class="o">,</span> <span class="nn">struct</span>
<span class="kn">from</span> <span class="nn">textwrap</span> <span class="kn">import</span> <span class="n">dedent</span>
<span class="kn">import</span> <span class="nn">signal</span>

<span class="kn">import</span> <span class="nn">SimpleHTTPServer</span>
<span class="kn">import</span> <span class="nn">SocketServer</span>

<span class="c"># Not in standard library</span>
<span class="kn">from</span> <span class="nn">termcolor</span> <span class="kn">import</span> <span class="n">colored</span>
<span class="kn">import</span> <span class="nn">colorama</span>
<span class="kn">import</span> <span class="nn">argparse</span> <span class="c"># in standard libraray for Python &gt;= 2.7</span>

<span class="c"># Private</span>
<span class="kn">from</span> <span class="nn">GeoBases</span> <span class="kn">import</span> <span class="n">GeoBase</span><span class="p">,</span> <span class="n">BASES</span>

<span class="c"># Do not produce broken pipes when head and tail are used</span>
<span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGPIPE</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_DFL</span><span class="p">)</span>



<div class="viewcode-block" id="checkPath"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.checkPath">[docs]</a><span class="k">def</span> <span class="nf">checkPath</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This checks if a command is in the PATH.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s">&#39;which </span><span class="si">%s</span><span class="s"> 2&gt; /dev/null&#39;</span> <span class="o">%</span> <span class="n">command</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

</div>
<div class="viewcode-block" id="getObsoleteTermSize"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.getObsoleteTermSize">[docs]</a><span class="k">def</span> <span class="nf">getObsoleteTermSize</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This gives terminal size information using external</span>
<span class="sd">    command stty.</span>
<span class="sd">    This function is not great since where stdin is used, it</span>
<span class="sd">    raises an error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s">&#39;stty size 2&gt;/dev/null&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">size</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="mi">160</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">size</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

</div>
<div class="viewcode-block" id="ioctl_GWINSZ"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.ioctl_GWINSZ">[docs]</a><span class="k">def</span> <span class="nf">ioctl_GWINSZ</span><span class="p">(</span><span class="n">fd</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read terminal size.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;hh&#39;</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">termios</span><span class="o">.</span><span class="n">TIOCGWINSZ</span><span class="p">,</span> <span class="s">&#39;1234&#39;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">return</span> <span class="n">cr</span>

</div>
<div class="viewcode-block" id="getTermSize"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.getTermSize">[docs]</a><span class="k">def</span> <span class="nf">getTermSize</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This gives terminal size information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
    <span class="n">cr</span>  <span class="o">=</span> <span class="n">ioctl_GWINSZ</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ioctl_GWINSZ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ioctl_GWINSZ</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">cr</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">ctermid</span><span class="p">(),</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span><span class="p">)</span>
            <span class="n">cr</span> <span class="o">=</span> <span class="n">ioctl_GWINSZ</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">cr</span><span class="p">:</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;LINES&#39;</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;COLUMNS&#39;</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">cr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">cr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

</div>
<div class="viewcode-block" id="RotatingColors"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.RotatingColors">[docs]</a><span class="k">class</span> <span class="nc">RotatingColors</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class is used for generating alternate colors</span>
<span class="sd">    for the Linux output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">background</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">background</span> <span class="o">==</span> <span class="s">&#39;black&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_availables</span> <span class="o">=</span> <span class="p">[</span>
                 <span class="p">(</span><span class="s">&#39;cyan&#39;</span><span class="p">,</span>  <span class="bp">None</span><span class="p">,</span>      <span class="p">[]),</span>
                 <span class="p">(</span><span class="s">&#39;white&#39;</span><span class="p">,</span> <span class="s">&#39;on_grey&#39;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="p">]</span>

        <span class="k">elif</span> <span class="n">background</span> <span class="o">==</span> <span class="s">&#39;white&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_availables</span> <span class="o">=</span> <span class="p">[</span>
                 <span class="p">(</span><span class="s">&#39;grey&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>       <span class="p">[]),</span>
                 <span class="p">(</span><span class="s">&#39;blue&#39;</span><span class="p">,</span> <span class="s">&#39;on_white&#39;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Accepted background color: &quot;black&quot; or &quot;white&quot;, not &quot;</span><span class="si">%s</span><span class="s">&quot;.&#39;</span> <span class="o">%</span> \
                             <span class="n">background</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_background</span> <span class="o">=</span> <span class="n">background</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current</span>    <span class="o">=</span> <span class="mi">0</span>


<div class="viewcode-block" id="RotatingColors.next"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.RotatingColors.next">[docs]</a>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;We increase the current color.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_availables</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current</span> <span class="o">=</span> <span class="mi">0</span>

</div>
<div class="viewcode-block" id="RotatingColors.get"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.RotatingColors.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get current color.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_availables</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_current</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="RotatingColors.convertRaw"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.RotatingColors.convertRaw">[docs]</a>    <span class="k">def</span> <span class="nf">convertRaw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get special raw color. Only change foreground color.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current</span>    <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">current</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;yellow&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_background</span> <span class="o">==</span> <span class="s">&#39;black&#39;</span> <span class="k">else</span> <span class="s">&#39;green&#39;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>

</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="RotatingColors.convertBold"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.RotatingColors.convertBold">[docs]</a>    <span class="k">def</span> <span class="nf">convertBold</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get special field color. Only change bold type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current</span>    <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">current</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;bold&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>

</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="RotatingColors.getEmph"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.RotatingColors.getEmph">[docs]</a>    <span class="k">def</span> <span class="nf">getEmph</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Get special emphasized color.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;white&#39;</span><span class="p">,</span> <span class="s">&#39;on_blue&#39;</span><span class="p">,</span> <span class="p">[])</span>

</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="RotatingColors.getHeader"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.RotatingColors.getHeader">[docs]</a>    <span class="k">def</span> <span class="nf">getHeader</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Get special header color.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;red&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">[])</span>

</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="RotatingColors.getSpecial"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.RotatingColors.getSpecial">[docs]</a>    <span class="k">def</span> <span class="nf">getSpecial</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Get special property color.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;magenta&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">[])</span>


</div></div>
<div class="viewcode-block" id="fmt_ref"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.fmt_ref">[docs]</a><span class="k">def</span> <span class="nf">fmt_ref</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">ref_type</span><span class="p">,</span> <span class="n">no_symb</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display the reference depending on its type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ref_type</span> <span class="o">==</span> <span class="s">&#39;distance&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">no_symb</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;</span><span class="si">%.3f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">ref</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%.2f</span><span class="s"> km&#39;</span> <span class="o">%</span> <span class="n">ref</span>

    <span class="k">if</span> <span class="n">ref_type</span> <span class="o">==</span> <span class="s">&#39;percentage&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">no_symb</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;</span><span class="si">%.3f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">ref</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%.1f</span><span class="s"> </span><span class="si">%%</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">ref</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ref_type</span> <span class="o">==</span> <span class="s">&#39;index&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;ref_type </span><span class="si">%s</span><span class="s"> was not allowed&#39;</span> <span class="o">%</span> <span class="n">ref_type</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="display"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.display">[docs]</a><span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="n">geob</span><span class="p">,</span> <span class="n">list_of_things</span><span class="p">,</span> <span class="n">omit</span><span class="p">,</span> <span class="n">show</span><span class="p">,</span> <span class="n">important</span><span class="p">,</span> <span class="n">ref_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main display function in Linux terminal, with</span>
<span class="sd">    nice color and everything.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">list_of_things</span><span class="p">:</span>
        <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">No elements to display.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">show</span> <span class="o">=</span> <span class="p">[</span><span class="n">REF</span><span class="p">]</span> <span class="o">+</span> <span class="n">geob</span><span class="o">.</span><span class="n">fields</span><span class="p">[:]</span>

    <span class="c"># Building final shown headers</span>
    <span class="n">show_wo_omit</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">show</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">omit</span><span class="p">]</span>

    <span class="c"># Different behaviour given number of results</span>
    <span class="c"># We adapt the width between MIN_CHAR_COL and MAX_CHAR_COL</span>
    <span class="c"># given number of columns and term width</span>
    <span class="n">n</span>   <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_of_things</span><span class="p">)</span>
    <span class="n">lim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">getTermSize</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">lim</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">MAX_CHAR_COL</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">MIN_CHAR_COL</span><span class="p">,</span> <span class="n">lim</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c"># We do not truncate names if only one result</span>
        <span class="n">truncate</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">truncate</span> <span class="o">=</span> <span class="n">lim</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">RotatingColors</span><span class="p">(</span><span class="n">BACKGROUND_COLOR</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">show_wo_omit</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">important</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">getEmph</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">f</span> <span class="o">==</span> <span class="n">REF</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">getHeader</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;__&#39;</span><span class="p">):</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">getSpecial</span><span class="p">()</span> <span class="c"># For special fields like __dup__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;@raw&#39;</span><span class="p">):</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">convertRaw</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>  <span class="c"># For @raw fields</span>

        <span class="c"># Fields on the left</span>
        <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">fixed_width</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">convertBold</span><span class="p">(</span><span class="n">col</span><span class="p">),</span> <span class="n">lim</span><span class="p">,</span> <span class="n">truncate</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="n">REF</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">list_of_things</span><span class="p">:</span>
                <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fixed_width</span><span class="p">(</span><span class="n">fmt_ref</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">ref_type</span><span class="p">),</span> <span class="n">col</span><span class="p">,</span> <span class="n">lim</span><span class="p">,</span> <span class="n">truncate</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">list_of_things</span><span class="p">:</span>
                <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fixed_width</span><span class="p">(</span><span class="n">geob</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">col</span><span class="p">,</span> <span class="n">lim</span><span class="p">,</span> <span class="n">truncate</span><span class="p">))</span>

        <span class="nb">next</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="display_quiet"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.display_quiet">[docs]</a><span class="k">def</span> <span class="nf">display_quiet</span><span class="p">(</span><span class="n">geob</span><span class="p">,</span> <span class="n">list_of_things</span><span class="p">,</span> <span class="n">omit</span><span class="p">,</span> <span class="n">show</span><span class="p">,</span> <span class="n">ref_type</span><span class="p">,</span> <span class="n">delim</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function displays the results in programming</span>
<span class="sd">    mode, with --quiet option. This is useful when you</span>
<span class="sd">    want to use use the result in a pipe for example.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">show</span><span class="p">:</span>
        <span class="c"># Temporary</span>
        <span class="n">t_show</span> <span class="o">=</span> <span class="p">[</span><span class="n">REF</span><span class="p">]</span> <span class="o">+</span> <span class="n">geob</span><span class="o">.</span><span class="n">fields</span><span class="p">[:]</span>

        <span class="c"># In this default case, we remove splitted valued if</span>
        <span class="c"># corresponding raw values exist</span>
        <span class="n">show</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">t_show</span> <span class="k">if</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">@raw&#39;</span> <span class="o">%</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">t_show</span><span class="p">]</span>

    <span class="c"># Building final shown headers</span>
    <span class="n">show_wo_omit</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">show</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">omit</span><span class="p">]</span>

    <span class="c"># Displaying headers</span>
    <span class="k">if</span> <span class="n">header</span> <span class="o">==</span> <span class="s">&#39;CH&#39;</span><span class="p">:</span>
        <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;#&#39;</span> <span class="o">+</span> <span class="n">delim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">show_wo_omit</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">header</span> <span class="o">==</span> <span class="s">&#39;RH&#39;</span><span class="p">:</span>
        <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">delim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">show_wo_omit</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Every other value will not display a header</span>
        <span class="k">pass</span>

    <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">list_of_things</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">show_wo_omit</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="n">REF</span><span class="p">:</span>
                <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fmt_ref</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">ref_type</span><span class="p">,</span> <span class="n">no_symb</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">geob</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="c"># Small workaround to display nicely lists in quiet mode</span>
                <span class="c"># Fields @raw are already handled with raw version, but</span>
                <span class="c"># __dup__ field has no raw version for dumping</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">v</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

        <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">delim</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="display_browser"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.display_browser">[docs]</a><span class="k">def</span> <span class="nf">display_browser</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">nb_res</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Display templates in the browser.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># We manually launch firefox, unless we risk a crash</span>
    <span class="n">to_be_launched</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">templates</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">template</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;_table.html&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">nb_res</span> <span class="o">&lt;=</span> <span class="n">TABLE_BROWSER_LIM</span><span class="p">:</span>
                <span class="n">to_be_launched</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;/!\ &quot;firefox localhost:</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot; not launched automatically. </span><span class="si">%s</span><span class="s"> results, may be slow.&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">PORT</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">nb_res</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">template</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;_map.html&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">nb_res</span> <span class="o">&lt;=</span> <span class="n">MAP_BROWSER_LIM</span><span class="p">:</span>
                <span class="n">to_be_launched</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;/!\ &quot;firefox localhost:</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&quot; not launched automatically. </span><span class="si">%s</span><span class="s"> results, may be slow.&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">PORT</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">nb_res</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">to_be_launched</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">to_be_launched</span><span class="p">:</span>
        <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;localhost:</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">PORT</span><span class="p">,</span> <span class="n">tpl</span><span class="p">)</span> <span class="k">for</span> <span class="n">tpl</span> <span class="ow">in</span> <span class="n">to_be_launched</span><span class="p">]</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;firefox </span><span class="si">%s</span><span class="s"> &amp;&#39;</span> <span class="o">%</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">urls</span><span class="p">))</span>


</div>
<div class="viewcode-block" id="launch_http_server"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.launch_http_server">[docs]</a><span class="k">def</span> <span class="nf">launch_http_server</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Launch a SimpleHTTPServer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">MyTCPServer</span><span class="p">(</span><span class="n">SocketServer</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Overrides standard library.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">allow_reuse_address</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">Handler</span> <span class="o">=</span> <span class="n">SimpleHTTPServer</span><span class="o">.</span><span class="n">SimpleHTTPRequestHandler</span>
    <span class="n">httpd</span>   <span class="o">=</span> <span class="n">MyTCPServer</span><span class="p">((</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="n">Handler</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;* Serving on localhost:</span><span class="si">%s</span><span class="s"> (hit ctrl+C to stop)&#39;</span> <span class="o">%</span> <span class="n">port</span>
        <span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">* Shutting down gracefully...&#39;</span>
        <span class="n">httpd</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&#39;* Done&#39;</span>


</div>
<div class="viewcode-block" id="fixed_width"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.fixed_width">[docs]</a><span class="k">def</span> <span class="nf">fixed_width</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">lim</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is useful to display a string in the</span>
<span class="sd">    terminal with a fixed width. It is especially</span>
<span class="sd">    tricky with unicode strings containing accents.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">truncate</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">truncate</span> <span class="o">=</span> <span class="mi">1000</span>

    <span class="n">printer</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%%</span><span class="s">-</span><span class="si">%s</span><span class="s">s&#39;</span> <span class="o">%</span> <span class="n">lim</span> <span class="c"># is something like &#39;%-3s&#39;</span>

    <span class="c"># To truncate on the appropriate number of characters</span>
    <span class="c"># We decode before truncating (so non-ascii characters</span>
    <span class="c"># will be counted only once when using len())</span>
    <span class="c"># Then we encode again for stdout.write</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span>                      <span class="c"># decode</span>
    <span class="n">es</span> <span class="o">=</span> <span class="p">(</span><span class="n">printer</span> <span class="o">%</span> <span class="n">ds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">truncate</span><span class="p">])</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span>  <span class="c"># encode</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">truncate</span><span class="p">:</span>
        <span class="n">es</span> <span class="o">=</span> <span class="n">es</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;… &#39;</span>

    <span class="k">return</span> <span class="n">colored</span><span class="p">(</span><span class="n">es</span><span class="p">,</span> <span class="o">*</span><span class="n">col</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="scan_coords"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.scan_coords">[docs]</a><span class="k">def</span> <span class="nf">scan_coords</span><span class="p">(</span><span class="n">u_input</span><span class="p">,</span> <span class="n">geob</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function tries to interpret the main</span>
<span class="sd">    argument as either coordinates (lat, lng) or</span>
<span class="sd">    a key like ORY.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># First we try input a direct key</span>
    <span class="k">if</span> <span class="n">u_input</span> <span class="ow">in</span> <span class="n">geob</span><span class="p">:</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">geob</span><span class="o">.</span><span class="n">getLocation</span><span class="p">(</span><span class="n">u_input</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s">&#39;geocode_unknown&#39;</span><span class="p">,</span> <span class="n">u_input</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">coords</span>

    <span class="c"># Then we try input as geocode</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">u_input</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;()&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">))</span>

    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>        <span class="ow">and</span> \
           <span class="o">-</span><span class="mi">90</span>  <span class="o">&lt;=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">90</span> <span class="ow">and</span> \
           <span class="o">-</span><span class="mi">180</span> <span class="o">&lt;=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">180</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;Geocode recognized: (</span><span class="si">%.3f</span><span class="s">, </span><span class="si">%.3f</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">coords</span>

            <span class="k">return</span> <span class="n">coords</span>

        <span class="n">error</span><span class="p">(</span><span class="s">&#39;geocode_format&#39;</span><span class="p">,</span> <span class="n">u_input</span><span class="p">)</span>

    <span class="c"># All cases failed</span>
    <span class="n">warn</span><span class="p">(</span><span class="s">&#39;key&#39;</span><span class="p">,</span> <span class="n">u_input</span><span class="p">,</span> <span class="n">geob</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="n">geob</span><span class="o">.</span><span class="n">_source</span><span class="p">)</span>
    <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="guess_delimiter"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.guess_delimiter">[docs]</a><span class="k">def</span> <span class="nf">guess_delimiter</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Heuristic to guess the top level delimiter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">discarded</span>  <span class="o">=</span> <span class="nb">set</span><span class="p">([</span>
        <span class="s">&#39;#&#39;</span><span class="p">,</span> <span class="c"># this is for comments</span>
        <span class="s">&#39;_&#39;</span><span class="p">,</span> <span class="c"># this is for spaces</span>
        <span class="s">&#39; &#39;</span><span class="p">,</span> <span class="c"># spaces are not usually delimiter, unless we find no other</span>
        <span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="c"># this is for quoting</span>
    <span class="p">])</span>
    <span class="n">candidates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">l</span><span class="o">.</span><span class="n">isalnum</span><span class="p">()</span> <span class="ow">and</span> <span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">discarded</span><span class="p">])</span>
    <span class="n">counters</span>   <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">c</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">)</span>

    <span class="c"># Testing spaces from higher to lower, break on biggest match</span>
    <span class="k">for</span> <span class="n">alternate</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]:</span>
        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">alternate</span><span class="p">):</span>
            <span class="n">counters</span><span class="p">[</span><span class="n">alternate</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">alternate</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">counters</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">counters</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># In this case, we could not find any delimiter, we may</span>
        <span class="c"># as well return &#39; &#39;</span>
        <span class="k">return</span> <span class="s">&#39; &#39;</span>

</div>
<div class="viewcode-block" id="generate_headers"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.generate_headers">[docs]</a><span class="k">def</span> <span class="nf">generate_headers</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate n headers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">yield</span> <span class="s">&#39;H</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span>

</div>
<div class="viewcode-block" id="guess_headers"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.guess_headers">[docs]</a><span class="k">def</span> <span class="nf">guess_headers</span><span class="p">(</span><span class="n">s_row</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Heuristic to guess the lat/lng fields from first row.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">generate_headers</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s_row</span><span class="p">)))</span>

    <span class="c"># Name candidates for lat/lng</span>
    <span class="n">lat_candidates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s">&#39;latitude&#39;</span><span class="p">,</span>  <span class="s">&#39;lat&#39;</span><span class="p">])</span>
    <span class="n">lng_candidates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s">&#39;longitude&#39;</span><span class="p">,</span> <span class="s">&#39;lng&#39;</span><span class="p">,</span> <span class="s">&#39;lon&#39;</span><span class="p">])</span>

    <span class="n">lat_found</span><span class="p">,</span> <span class="n">lng_found</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s_row</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c"># Here the line was not a number, we check the name</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">lat_candidates</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lat_found</span><span class="p">:</span>
                <span class="n">headers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;lat&#39;</span>
                <span class="n">lat_found</span>  <span class="o">=</span> <span class="bp">True</span>

            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">lng_candidates</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lng_found</span><span class="p">:</span>
                <span class="n">headers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;lng&#39;</span>
                <span class="n">lng_found</span>  <span class="o">=</span> <span class="bp">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                <span class="c"># Round values are improbable as lat/lng</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="o">-</span><span class="mi">90</span> <span class="o">&lt;=</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="mi">90</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lat_found</span><span class="p">:</span>
                <span class="c"># possible latitude field</span>
                <span class="n">headers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;lat&#39;</span>
                <span class="n">lat_found</span>  <span class="o">=</span> <span class="bp">True</span>

            <span class="k">elif</span> <span class="o">-</span><span class="mi">180</span> <span class="o">&lt;=</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="mi">180</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lng_found</span><span class="p">:</span>
                <span class="c"># possible longitude field</span>
                <span class="n">headers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;lng&#39;</span>
                <span class="n">lng_found</span>  <span class="o">=</span> <span class="bp">True</span>

    <span class="k">return</span> <span class="n">headers</span>

</div>
<div class="viewcode-block" id="score_index"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.score_index">[docs]</a><span class="k">def</span> <span class="nf">score_index</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Eval likelihood of being an index.</span>

<span class="sd">    The shorter the better, and int get a len() of 1.</span>
<span class="sd">    0, 1 and floats are weird for indexes, as well as 1-letter strings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;__key__&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1000</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># we avoid a domain error on next case</span>
            <span class="k">return</span> <span class="mi">10</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">25</span> <span class="o">/</span> <span class="n">log</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">10</span>

</div>
<div class="viewcode-block" id="guess_indexes"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.guess_indexes">[docs]</a><span class="k">def</span> <span class="nf">guess_indexes</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">s_row</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Heuristic to guess indexes from headers and first row.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">discarded</span>  <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s">&#39;lat&#39;</span><span class="p">,</span> <span class="s">&#39;lng&#39;</span><span class="p">])</span>
    <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">s_row</span><span class="p">):</span>
        <span class="c"># Skip discarded and empty values</span>
        <span class="k">if</span> <span class="n">h</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">discarded</span> <span class="ow">and</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c"># is *not* a number</span>
                <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">score_index</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># is a number</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                    <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">score_index</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">))))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">score_index</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">headers</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">return</span> <span class="p">[</span> <span class="nb">min</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span>

</div>
<div class="viewcode-block" id="fmt_on_two_cols"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.fmt_on_two_cols">[docs]</a><span class="k">def</span> <span class="nf">fmt_on_two_cols</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">descriptor</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s">&#39;v&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Some formatting for help.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">L</span><span class="p">))</span>
    <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ceil</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="c"># half+</span>

    <span class="k">if</span> <span class="n">layout</span> <span class="o">==</span> <span class="s">&#39;h&#39;</span><span class="p">:</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="n">izip_longest</span><span class="p">(</span><span class="n">L</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">L</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">],</span> <span class="n">fillvalue</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">layout</span> <span class="o">==</span> <span class="s">&#39;v&#39;</span><span class="p">:</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="n">izip_longest</span><span class="p">(</span><span class="n">L</span><span class="p">[:</span><span class="n">h</span><span class="p">],</span> <span class="n">L</span><span class="p">[</span><span class="n">h</span><span class="p">:],</span> <span class="n">fillvalue</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Layout must be &quot;h&quot; or &quot;v&quot;, but was &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">layout</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">descriptor</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\t</span><span class="si">%-20s</span><span class="se">\t</span><span class="si">%-20s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">p</span>

</div>
<div class="viewcode-block" id="best_field"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.best_field">[docs]</a><span class="k">def</span> <span class="nf">best_field</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">possibilities</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Select best candidate in possibilities.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">possibilities</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">candidate</span>
    <span class="k">return</span> <span class="n">default</span>

</div>
<div class="viewcode-block" id="warn"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.warn">[docs]</a><span class="k">def</span> <span class="nf">warn</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display a warning on stderr.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;key&#39;</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;/!\ Key </span><span class="si">%s</span><span class="s"> was not in GeoBase, for data &quot;</span><span class="si">%s</span><span class="s">&quot; and source </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

</div>
<div class="viewcode-block" id="error"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.error">[docs]</a><span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display an error on stderr, then exit.</span>
<span class="sd">    First argument is the error type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;trep_support&#39;</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">/!\ No opentrep support. Check if OpenTrepWrapper can import libpyopentrep.&#39;</span>

    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;geocode_support&#39;</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">/!\ No geocoding support for data type </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;base&#39;</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">/!\ Wrong data type &quot;</span><span class="si">%s</span><span class="s">&quot;. You may select:&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fmt_on_two_cols</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">stderr</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;property&#39;</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">/!\ Wrong property &quot;</span><span class="si">%s</span><span class="s">&quot;.&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;For data type &quot;</span><span class="si">%s</span><span class="s">&quot;, you may select:&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">fmt_on_two_cols</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">stderr</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;field&#39;</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">/!\ Wrong field &quot;</span><span class="si">%s</span><span class="s">&quot;.&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;For data type &quot;</span><span class="si">%s</span><span class="s">&quot;, you may select:&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">fmt_on_two_cols</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">stderr</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;geocode_format&#39;</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">/!\ Bad geocode format: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;geocode_unknown&#39;</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">/!\ Geocode was unknown for </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;empty_stdin&#39;</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">/!\ Stdin was empty&#39;</span>

    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;wrong_value&#39;</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">/!\ Wrong value &quot;</span><span class="si">%s</span><span class="s">&quot;, should be in &quot;</span><span class="si">%s</span><span class="s">&quot;.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;type&#39;</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">/!\ Wrong type for &quot;</span><span class="si">%s</span><span class="s">&quot;, should be </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="c">#######</span>
<span class="c">#</span>
<span class="c">#  MAIN</span>
<span class="c">#</span>
<span class="c">#######</span>

<span class="c"># Global defaults</span></div>
<span class="n">DEF_BASE</span>          <span class="o">=</span> <span class="s">&#39;ori_por&#39;</span>
<span class="n">DEF_FUZZY_LIMIT</span>   <span class="o">=</span> <span class="mf">0.85</span>
<span class="n">DEF_NEAR_LIMIT</span>    <span class="o">=</span> <span class="mf">50.</span>
<span class="n">DEF_CLOSEST_LIMIT</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">DEF_TREP_FORMAT</span>   <span class="o">=</span> <span class="s">&#39;S&#39;</span>
<span class="n">DEF_QUIET_DELIM</span>   <span class="o">=</span> <span class="s">&#39;^&#39;</span>
<span class="n">DEF_QUIET_HEADER</span>  <span class="o">=</span> <span class="s">&#39;CH&#39;</span>
<span class="n">DEF_INTER_FUZZY_L</span> <span class="o">=</span> <span class="mf">0.99</span>
<span class="n">DEF_FUZZY_FIELDS</span>  <span class="o">=</span> <span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;country_name&#39;</span><span class="p">,</span> <span class="s">&#39;currency_name&#39;</span><span class="p">,</span> <span class="s">&#39;__key__&#39;</span><span class="p">)</span>

<span class="n">ALLOWED_ICON_TYPES</span>  <span class="o">=</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;auto&#39;</span><span class="p">,</span> <span class="s">&#39;S&#39;</span><span class="p">,</span> <span class="s">&#39;B&#39;</span><span class="p">)</span>
<span class="n">ALLOWED_INTER_TYPES</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;__exact__&#39;</span><span class="p">,</span> <span class="s">&#39;__fuzzy__&#39;</span><span class="p">)</span>

<span class="n">DEF_INTER_FIELD</span> <span class="o">=</span> <span class="s">&#39;__key__&#39;</span>
<span class="n">DEF_INTER_TYPE</span>  <span class="o">=</span> <span class="s">&#39;__exact__&#39;</span>

<span class="c"># Considered truthy values for command line option</span>
<span class="n">TRUTHY</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="s">&#39;Y&#39;</span><span class="p">)</span>

<span class="c"># Duplicates handling in feed mode</span>
<span class="n">DEF_DISCARD_RAW</span> <span class="o">=</span> <span class="s">&#39;F&#39;</span>
<span class="n">DEF_DISCARD</span>     <span class="o">=</span> <span class="bp">False</span>

<span class="c"># Magic value option to skip and leave default, or disable</span>
<span class="n">SKIP</span>    <span class="o">=</span> <span class="s">&#39;_&#39;</span>
<span class="n">SPLIT</span>   <span class="o">=</span> <span class="s">&#39;/&#39;</span>
<span class="n">DISABLE</span> <span class="o">=</span> <span class="s">&#39;__none__&#39;</span>
<span class="n">REF</span>     <span class="o">=</span> <span class="s">&#39;__ref__&#39;</span>

<span class="c"># Port for SimpleHTTPServer</span>
<span class="n">ADDRESS</span> <span class="o">=</span> <span class="s">&#39;0.0.0.0&#39;</span>
<span class="n">PORT</span>    <span class="o">=</span> <span class="mi">8000</span>

<span class="c"># Defaults for map</span>
<span class="n">DEF_LABEL_FIELDS</span>    <span class="o">=</span> <span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span>       <span class="s">&#39;country_name&#39;</span><span class="p">,</span> <span class="s">&#39;__key__&#39;</span><span class="p">)</span>
<span class="n">DEF_SIZE_FIELDS</span>     <span class="o">=</span> <span class="p">(</span><span class="s">&#39;page_rank&#39;</span><span class="p">,</span>  <span class="s">&#39;population&#39;</span><span class="p">,</span>   <span class="bp">None</span><span class="p">)</span>
<span class="n">DEF_COLOR_FIELDS</span>    <span class="o">=</span> <span class="p">(</span><span class="s">&#39;raw_offset&#39;</span><span class="p">,</span> <span class="s">&#39;fclass&#39;</span><span class="p">,</span>       <span class="bp">None</span><span class="p">)</span>
<span class="n">DEF_ICON_TYPE</span>       <span class="o">=</span> <span class="s">&#39;auto&#39;</span> <span class="c"># icon type: small, big, auto, ...</span>
<span class="n">DEF_LINK_DUPLICATES</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">MAP_BROWSER_LIM</span>   <span class="o">=</span> <span class="mi">8000</span>   <span class="c"># limit for launching browser automatically</span>
<span class="n">TABLE_BROWSER_LIM</span> <span class="o">=</span> <span class="mi">2000</span>   <span class="c"># limit for launching browser automatically</span>

<span class="c"># Terminal width defaults</span>
<span class="n">DEF_CHAR_COL</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">MIN_CHAR_COL</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">MAX_CHAR_COL</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">DEF_NUM_COL</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">getTermSize</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">DEF_CHAR_COL</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>

<span class="n">ENV_WARNINGS</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">BACKGROUND_COLOR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;BACKGROUND_COLOR&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="c"># &#39;white&#39;</span>

<span class="k">if</span> <span class="n">BACKGROUND_COLOR</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;black&#39;</span><span class="p">,</span> <span class="s">&#39;white&#39;</span><span class="p">]:</span>
    <span class="n">ENV_WARNINGS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span>
<span class="s">    **********************************************************************</span>
<span class="s">    $BACKGROUND_COLOR environment variable not properly set.             *</span>
<span class="s">    Accepted values are &#39;black&#39; and &#39;white&#39;. Using default &#39;black&#39; here. *</span>
<span class="s">    To disable this message, add to your ~/.bashrc or ~/.zshrc:          *</span>
<span class="s">                                                                         *</span>
<span class="s">        export BACKGROUND_COLOR=black # or white</span>
<span class="s">                                                                         *</span>
<span class="s">    *************************************************************** README</span>
<span class="s">    &#39;&#39;&#39;</span><span class="p">)</span>

    <span class="n">BACKGROUND_COLOR</span> <span class="o">=</span> <span class="s">&#39;black&#39;</span>


<span class="k">if</span> <span class="ow">not</span> <span class="n">checkPath</span><span class="p">(</span><span class="s">&#39;GeoBase&#39;</span><span class="p">):</span>
    <span class="n">ENV_WARNINGS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span>
<span class="s">    **********************************************************************</span>
<span class="s">    &quot;GeoBase&quot; does not seem to be in your $PATH.                         *</span>
<span class="s">    To disable this message, add to your ~/.bashrc or ~/.zshrc:          *</span>
<span class="s">                                                                         *</span>
<span class="s">        export PATH=$PATH:$HOME/.local/bin</span>
<span class="s">                                                                         *</span>
<span class="s">    *************************************************************** README</span>
<span class="s">    &#39;&#39;&#39;</span><span class="p">)</span>


<span class="k">if</span> <span class="n">ENV_WARNINGS</span><span class="p">:</span>
    <span class="c"># Assume the user did not read the wiki :D</span>
    <span class="n">ENV_WARNINGS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span>
<span class="s">    **********************************************************************</span>
<span class="s">    By the way, since you probably did not read the documentation :D,    *</span>
<span class="s">    you should also add this for the completion to work with zsh.        *</span>
<span class="s">    You&#39;re using zsh right o_O?                                          *</span>
<span class="s">                                                                         *</span>
<span class="s">        # Add custom completion scripts</span>
<span class="s">        fpath=(~/.zsh/completion $fpath)</span>
<span class="s">        autoload -U compinit</span>
<span class="s">        compinit</span>
<span class="s">                                                                         *</span>
<span class="s">    *************************************************************** README</span>
<span class="s">    &#39;&#39;&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="handle_args"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.handle_args">[docs]</a><span class="k">def</span> <span class="nf">handle_args</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Command line parsing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># or list formatter</span>
    <span class="n">fmt_or</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">L</span> <span class="p">:</span> <span class="s">&#39; or &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">e</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="s">&#39;None&#39;</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">L</span><span class="p">)</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">&#39;Provides data services.&#39;</span><span class="p">,</span>
                                     <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawTextHelpFormatter</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">epilog</span> <span class="o">=</span> <span class="s">&#39;Example: </span><span class="si">%s</span><span class="s"> ORY CDG&#39;</span> <span class="o">%</span> <span class="n">parser</span><span class="o">.</span><span class="n">prog</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;keys&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        Main argument. This will be used as a list of keys on which we</span>
<span class="s">        apply filters. Leave empty to consider all keys.</span>
<span class="s">        &#39;&#39;&#39;</span><span class="p">),</span>
        <span class="n">nargs</span> <span class="o">=</span> <span class="s">&#39;*&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-b&#39;</span><span class="p">,</span> <span class="s">&#39;--base&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        Choose a different data type, default is &quot;</span><span class="si">%s</span><span class="s">&quot;. Also available are</span>
<span class="s">        stations, airports, countries... Give unadmissible value</span>
<span class="s">        and all possibilities will be displayed.</span>
<span class="s">        &#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">DEF_BASE</span><span class="p">),</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">DEF_BASE</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-f&#39;</span><span class="p">,</span> <span class="s">&#39;--fuzzy&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        Rather than looking up a key, this mode will search the best</span>
<span class="s">        match from the property given by --fuzzy-property option for</span>
<span class="s">        the argument. Limit can be specified with --fuzzy-limit option.</span>
<span class="s">        &#39;&#39;&#39;</span><span class="p">),</span>
        <span class="n">default</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">nargs</span> <span class="o">=</span> <span class="s">&#39;+&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-F&#39;</span><span class="p">,</span> <span class="s">&#39;--fuzzy-property&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        When performing a fuzzy search, specify the property to be chosen.</span>
<span class="s">        Default is </span><span class="si">%s</span><span class="s"></span>
<span class="s">        depending on fields.</span>
<span class="s">        Give unadmissible property and available values will be displayed.</span>
<span class="s">        &#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">fmt_or</span><span class="p">(</span><span class="n">DEF_FUZZY_FIELDS</span><span class="p">)),</span>
        <span class="n">default</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-L&#39;</span><span class="p">,</span> <span class="s">&#39;--fuzzy-limit&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        Specify a min limit for fuzzy searches, default is </span><span class="si">%s</span><span class="s">.</span>
<span class="s">        This is the Levenshtein ratio of the two strings.</span>
<span class="s">        &#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">DEF_FUZZY_LIMIT</span><span class="p">),</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">DEF_FUZZY_LIMIT</span><span class="p">,</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-e&#39;</span><span class="p">,</span> <span class="s">&#39;--exact&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        Rather than looking up a key, this mode will search all keys</span>
<span class="s">        whose specific property given by --exact-property match the</span>
<span class="s">        argument. By default, the &quot;__key__&quot; property is used for the search.</span>
<span class="s">        &#39;&#39;&#39;</span><span class="p">),</span>
        <span class="n">default</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">nargs</span> <span class="o">=</span> <span class="s">&#39;+&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-E&#39;</span><span class="p">,</span> <span class="s">&#39;--exact-property&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        When performing an exact search, specify the property to be chosen.</span>
<span class="s">        Default is &quot;__key__&quot;. Give unadmissible property and available</span>
<span class="s">        values will be displayed.</span>
<span class="s">        &#39;&#39;&#39;</span><span class="p">),</span>
        <span class="n">default</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-r&#39;</span><span class="p">,</span> <span class="s">&#39;--reverse&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        When possible, reverse the logic of the filter. Currently</span>
<span class="s">        only --exact supports that.</span>
<span class="s">        &#39;&#39;&#39;</span><span class="p">),</span>
        <span class="n">action</span> <span class="o">=</span> <span class="s">&#39;store_true&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-n&#39;</span><span class="p">,</span> <span class="s">&#39;--near&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        Rather than looking up a key, this mode will search the entries</span>
<span class="s">        in a radius from a geocode or a key. Radius is given by --near-limit</span>
<span class="s">        option, and geocode is passed as argument. If you wish to give a geocode</span>
<span class="s">        as input, just pass it as argument with &quot;lat, lng&quot; format.</span>
<span class="s">        &#39;&#39;&#39;</span><span class="p">),</span>
        <span class="n">default</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">nargs</span> <span class="o">=</span> <span class="s">&#39;+&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-N&#39;</span><span class="p">,</span> <span class="s">&#39;--near-limit&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        Specify a radius in km when performing geographical</span>
<span class="s">        searches with --near. Default is </span><span class="si">%s</span><span class="s"> km.</span>
<span class="s">        &#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">DEF_NEAR_LIMIT</span><span class="p">),</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">DEF_NEAR_LIMIT</span><span class="p">,</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="s">&#39;--closest&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        Rather than looking up a key, this mode will search the closest entries</span>
<span class="s">        from a geocode or a key. Number of results is limited by --closest-limit</span>
<span class="s">        option, and geocode is passed as argument. If you wish to give a geocode</span>
<span class="s">        as input, just pass it as argument with &quot;lat, lng&quot; format.</span>
<span class="s">        &#39;&#39;&#39;</span><span class="p">),</span>
        <span class="n">default</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">nargs</span> <span class="o">=</span> <span class="s">&#39;+&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-C&#39;</span><span class="p">,</span> <span class="s">&#39;--closest-limit&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        Specify a limit for closest search with --closest, default is </span><span class="si">%s</span><span class="s">.</span>
<span class="s">        &#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">DEF_CLOSEST_LIMIT</span><span class="p">),</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">DEF_CLOSEST_LIMIT</span><span class="p">,</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-t&#39;</span><span class="p">,</span> <span class="s">&#39;--trep&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        Rather than looking up a key, this mode will use opentrep.</span>
<span class="s">        &#39;&#39;&#39;</span><span class="p">),</span>
        <span class="n">default</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">nargs</span> <span class="o">=</span> <span class="s">&#39;+&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-T&#39;</span><span class="p">,</span> <span class="s">&#39;--trep-format&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        Specify a format for trep searches with --trep, default is &quot;</span><span class="si">%s</span><span class="s">&quot;.</span>
<span class="s">        &#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">DEF_TREP_FORMAT</span><span class="p">),</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">DEF_TREP_FORMAT</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-g&#39;</span><span class="p">,</span> <span class="s">&#39;--gridless&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        When performing a geographical search, a geographical index is used.</span>
<span class="s">        This may lead to inaccurate results in some (rare) case when using</span>
<span class="s">        --closest searches (--near searches are never impacted).</span>
<span class="s">        Adding this option will disable the index, and browse the full</span>
<span class="s">        data set to look for the results.</span>
<span class="s">        &#39;&#39;&#39;</span><span class="p">),</span>
        <span class="n">action</span> <span class="o">=</span> <span class="s">&#39;store_true&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-o&#39;</span><span class="p">,</span> <span class="s">&#39;--omit&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        Does not print some fields on stdout.</span>
<span class="s">        May help to get cleaner output.</span>
<span class="s">        &quot;</span><span class="si">%s</span><span class="s">&quot; is an available keyword as well as any other geobase fields.</span>
<span class="s">        &#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">REF</span><span class="p">),</span>
        <span class="n">nargs</span> <span class="o">=</span> <span class="s">&#39;+&#39;</span><span class="p">,</span>
        <span class="n">default</span> <span class="o">=</span> <span class="p">[])</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-s&#39;</span><span class="p">,</span> <span class="s">&#39;--show&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        Only print some fields on stdout.</span>
<span class="s">        May help to get cleaner output.</span>
<span class="s">        &quot;</span><span class="si">%s</span><span class="s">&quot; is an available keyword as well as any other geobase fields.</span>
<span class="s">        &#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">REF</span><span class="p">),</span>
        <span class="n">nargs</span> <span class="o">=</span> <span class="s">&#39;+&#39;</span><span class="p">,</span>
        <span class="n">default</span> <span class="o">=</span> <span class="p">[])</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-l&#39;</span><span class="p">,</span> <span class="s">&#39;--limit&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        Specify a limit for the number of results.</span>
<span class="s">        This must be an integer.</span>
<span class="s">        Default is </span><span class="si">%s</span><span class="s">, except in quiet mode where it is disabled.</span>
<span class="s">        &#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">DEF_NUM_COL</span><span class="p">),</span>
        <span class="n">default</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-i&#39;</span><span class="p">,</span> <span class="s">&#39;--indexes&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        Specify metadata, for stdin input as well as existing bases.</span>
<span class="s">        This will override defaults for existing bases.</span>
<span class="s">        4 optional arguments: delimiter, headers, indexes, discard_dups.</span>
<span class="s">            1) default delimiter is smart :).</span>
<span class="s">            2) default headers will use numbers, and try to sniff lat/lng.</span>
<span class="s">               Use __head__ as header value to</span>
<span class="s">               burn the first line to define the headers.</span>
<span class="s">            3) default indexes will take the first plausible field.</span>
<span class="s">            4) discard_dups is a boolean to toggle duplicated keys dropping.</span>
<span class="s">               Default is </span><span class="si">%s</span><span class="s">. Put </span><span class="si">%s</span><span class="s"> as a truthy value,</span>
<span class="s">               any other value will be falsy.</span>
<span class="s">        Multiple fields may be specified with &quot;</span><span class="si">%s</span><span class="s">&quot; delimiter.</span>
<span class="s">        For any field, you may put &quot;</span><span class="si">%s</span><span class="s">&quot; to leave the default value.</span>
<span class="s">        Example: -i &#39;,&#39; key/name/country key/country _</span>
<span class="s">        &#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DEF_DISCARD</span><span class="p">,</span> <span class="n">fmt_or</span><span class="p">(</span><span class="n">TRUTHY</span><span class="p">),</span> <span class="n">SPLIT</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">)),</span>
        <span class="n">nargs</span> <span class="o">=</span> <span class="s">&#39;+&#39;</span><span class="p">,</span>
        <span class="n">metavar</span> <span class="o">=</span> <span class="s">&#39;METADATA&#39;</span><span class="p">,</span>
        <span class="n">default</span> <span class="o">=</span> <span class="p">[])</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-I&#39;</span><span class="p">,</span> <span class="s">&#39;--interactive-query&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        If passed, this option will consider stdin</span>
<span class="s">        input as key for query, not data for loading.</span>
<span class="s">        2 optional arguments: field, type.</span>
<span class="s">            1) field is the field from which the data is supposed to be.</span>
<span class="s">            2) type is the type of matching, either </span><span class="si">%s</span><span class="s">.</span>
<span class="s">               For fuzzy searches, the ratio is set to </span><span class="si">%s</span><span class="s">.</span>
<span class="s">        For any field, you may put &quot;</span><span class="si">%s</span><span class="s">&quot; to leave the default value.</span>
<span class="s">        Example: -I icao_code __fuzzy__</span>
<span class="s">        &#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fmt_or</span><span class="p">(</span><span class="n">ALLOWED_INTER_TYPES</span><span class="p">),</span> <span class="n">DEF_INTER_FUZZY_L</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">)),</span>
        <span class="n">nargs</span> <span class="o">=</span> <span class="s">&#39;*&#39;</span><span class="p">,</span>
        <span class="n">metavar</span> <span class="o">=</span> <span class="s">&#39;OPTION&#39;</span><span class="p">,</span>
        <span class="n">default</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-q&#39;</span><span class="p">,</span> <span class="s">&#39;--quiet&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        Turn off verbosity and provide a programmer friendly output.</span>
<span class="s">        This is a csv-like output, and may still be combined with</span>
<span class="s">        --omit and --show. Configure with --quiet-options.</span>
<span class="s">        &#39;&#39;&#39;</span><span class="p">),</span>
        <span class="n">action</span> <span class="o">=</span> <span class="s">&#39;store_true&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-Q&#39;</span><span class="p">,</span> <span class="s">&#39;--quiet-options&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        Custom the quiet mode.</span>
<span class="s">        2 optional arguments: delimiter, header.</span>
<span class="s">            1) default delimiter is &quot;</span><span class="si">%s</span><span class="s">&quot;.</span>
<span class="s">            2) the second parameter is used to control</span>
<span class="s">               header display:</span>
<span class="s">                   - RH to add a raw header,</span>
<span class="s">                   - CH to add a commented header,</span>
<span class="s">                   - any other value will not display the header.</span>
<span class="s">               Default is &quot;</span><span class="si">%s</span><span class="s">&quot;.</span>
<span class="s">        For any field, you may put &quot;</span><span class="si">%s</span><span class="s">&quot; to leave the default value.</span>
<span class="s">        Example: -Q &#39;;&#39; RH</span>
<span class="s">        &#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DEF_QUIET_DELIM</span><span class="p">,</span> <span class="n">DEF_QUIET_HEADER</span><span class="p">,</span> <span class="n">SKIP</span><span class="p">)),</span>
        <span class="n">nargs</span> <span class="o">=</span> <span class="s">&#39;+&#39;</span><span class="p">,</span>
        <span class="n">metavar</span> <span class="o">=</span> <span class="s">&#39;INFO&#39;</span><span class="p">,</span>
        <span class="n">default</span> <span class="o">=</span> <span class="p">[])</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-m&#39;</span><span class="p">,</span> <span class="s">&#39;--map&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        This is the map output.</span>
<span class="s">        Configure with --map-data.</span>
<span class="s">        &#39;&#39;&#39;</span><span class="p">),</span>
        <span class="n">action</span> <span class="o">=</span> <span class="s">&#39;store_true&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-M&#39;</span><span class="p">,</span> <span class="s">&#39;--map-data&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        5 optional arguments: label, size, color, icon, duplicates.</span>
<span class="s">            1) label is the field to display on map points.</span>
<span class="s">               Default is </span><span class="si">%s</span><span class="s"> depending on fields.</span>
<span class="s">            2) size is the field used to draw circles around points.</span>
<span class="s">               Default is </span><span class="si">%s</span><span class="s"> depending on fields.</span>
<span class="s">               Put &quot;</span><span class="si">%s</span><span class="s">&quot; to disable circles.</span>
<span class="s">            3) color is the field use to color icons.</span>
<span class="s">               Default is </span><span class="si">%s</span><span class="s"> depending on fields.</span>
<span class="s">               Put &quot;</span><span class="si">%s</span><span class="s">&quot; to disable coloring.</span>
<span class="s">            4) icon is the icon type, either:</span>
<span class="s">                   - &quot;B&quot; for big,</span>
<span class="s">                   - &quot;S&quot; for small,</span>
<span class="s">                   - &quot;auto&quot; for automatic,</span>
<span class="s">                   - &quot;</span><span class="si">%s</span><span class="s">&quot; to disable icons.</span>
<span class="s">               Default is &quot;</span><span class="si">%s</span><span class="s">&quot;.</span>
<span class="s">            5) duplicates is a boolean to toggle lines between duplicated keys.</span>
<span class="s">               Default is </span><span class="si">%s</span><span class="s">. Put </span><span class="si">%s</span><span class="s"> as a truthy value,</span>
<span class="s">               any other value will be falsy.</span>
<span class="s">        For any field, you may put &quot;</span><span class="si">%s</span><span class="s">&quot; to leave the default value.</span>
<span class="s">        Example: -M _ population _ __none__ _</span>
<span class="s">        &#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="n">fmt_or</span><span class="p">(</span><span class="n">DEF_LABEL_FIELDS</span><span class="p">),</span> <span class="n">fmt_or</span><span class="p">(</span><span class="n">DEF_SIZE_FIELDS</span><span class="p">),</span> <span class="n">DISABLE</span><span class="p">,</span>
                <span class="n">fmt_or</span><span class="p">(</span><span class="n">DEF_COLOR_FIELDS</span><span class="p">),</span> <span class="n">DISABLE</span><span class="p">,</span> <span class="n">DISABLE</span><span class="p">,</span> <span class="n">DEF_ICON_TYPE</span><span class="p">,</span>
                <span class="n">DEF_LINK_DUPLICATES</span><span class="p">,</span> <span class="n">fmt_or</span><span class="p">(</span><span class="n">TRUTHY</span><span class="p">),</span> <span class="n">SKIP</span><span class="p">))),</span>
        <span class="n">nargs</span> <span class="o">=</span> <span class="s">&#39;+&#39;</span><span class="p">,</span>
        <span class="n">metavar</span> <span class="o">=</span> <span class="s">&#39;FIELDS&#39;</span><span class="p">,</span>
        <span class="n">default</span> <span class="o">=</span> <span class="p">[])</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-w&#39;</span><span class="p">,</span> <span class="s">&#39;--warnings&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        Provides additional information from data loading.</span>
<span class="s">        &#39;&#39;&#39;</span><span class="p">),</span>
        <span class="n">action</span> <span class="o">=</span> <span class="s">&#39;store_true&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-u&#39;</span><span class="p">,</span> <span class="s">&#39;--update&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        If this option is set, instead of anything,</span>
<span class="s">        the script will try to update the data files.</span>
<span class="s">        Differences will be shown and the user has to answer</span>
<span class="s">        &#39;Y&#39; or &#39;N&#39; for each file.</span>
<span class="s">        &#39;&#39;&#39;</span><span class="p">),</span>
        <span class="n">action</span> <span class="o">=</span> <span class="s">&#39;store_true&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-U&#39;</span><span class="p">,</span> <span class="s">&#39;--update-forced&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        If this option is set, instead of anything,</span>
<span class="s">        the script will force the update of all data files.</span>
<span class="s">        &#39;&#39;&#39;</span><span class="p">),</span>
        <span class="n">action</span> <span class="o">=</span> <span class="s">&#39;store_true&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;-v&#39;</span><span class="p">,</span> <span class="s">&#39;--version&#39;</span><span class="p">,</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">dedent</span><span class="p">(</span><span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        Display version information.</span>
<span class="s">        &#39;&#39;&#39;</span><span class="p">),</span>
        <span class="n">action</span> <span class="o">=</span> <span class="s">&#39;store_true&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">vars</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">())</span>

</div>
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../GeoBaseMain.html#GeoBaseMain.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Arguments handling.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Filter colored signals on terminals.</span>
    <span class="c"># Necessary for Windows CMD</span>
    <span class="n">colorama</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

    <span class="c">#</span>
    <span class="c"># COMMAND LINE MANAGEMENT</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">handle_args</span><span class="p">()</span>


    <span class="c">#</span>
    <span class="c"># ARGUMENTS</span>
    <span class="c">#</span>
    <span class="n">with_grid</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;gridless&#39;</span><span class="p">]</span>
    <span class="n">verbose</span>   <span class="o">=</span> <span class="ow">not</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;quiet&#39;</span><span class="p">]</span>
    <span class="n">warnings</span>  <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;warnings&#39;</span><span class="p">]</span>

    <span class="c"># Defining frontend</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;map&#39;</span><span class="p">]:</span>
        <span class="n">frontend</span> <span class="o">=</span> <span class="s">&#39;map&#39;</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;quiet&#39;</span><span class="p">]:</span>
        <span class="n">frontend</span> <span class="o">=</span> <span class="s">&#39;terminal&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">frontend</span> <span class="o">=</span> <span class="s">&#39;quiet&#39;</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;limit&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># Limit was not set by user</span>
        <span class="k">if</span> <span class="n">frontend</span> <span class="o">==</span> <span class="s">&#39;terminal&#39;</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="n">DEF_NUM_COL</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;limit&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;limit&#39;</span><span class="p">],</span> <span class="s">&#39;int&#39;</span><span class="p">)</span>

    <span class="c"># Interactive query?</span>
    <span class="n">interactive_query_mode</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;interactive_query&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>


    <span class="c">#</span>
    <span class="c"># CREATION</span>
    <span class="c">#</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">before_init</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;version&#39;</span><span class="p">]:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="s">&quot;GeoBases&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">print</span> <span class="s">&#39;Project  : </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">r</span><span class="o">.</span><span class="n">project_name</span>
        <span class="k">print</span> <span class="s">&#39;Version  : </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">r</span><span class="o">.</span><span class="n">version</span>
        <span class="k">print</span> <span class="s">&#39;Egg name : </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">r</span><span class="o">.</span><span class="n">egg_name</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&#39;Location : </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">r</span><span class="o">.</span><span class="n">location</span>
        <span class="k">print</span> <span class="s">&#39;Requires : </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">requires</span><span class="p">())</span>
        <span class="k">print</span> <span class="s">&#39;Extras   : </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">extras</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;base&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">BASES</span><span class="p">:</span>
        <span class="n">error</span><span class="p">(</span><span class="s">&#39;base&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;base&#39;</span><span class="p">],</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">BASES</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="c"># Updating file</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;update&#39;</span><span class="p">]:</span>
        <span class="n">GeoBase</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;update_forced&#39;</span><span class="p">]:</span>
        <span class="n">GeoBase</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">stdin</span><span class="o">.</span><span class="n">isatty</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">interactive_query_mode</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">first_l</span> <span class="o">=</span> <span class="n">stdin</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s">&#39;empty_stdin&#39;</span><span class="p">)</span>

        <span class="n">source</span>  <span class="o">=</span> <span class="n">chain</span><span class="p">([</span><span class="n">first_l</span><span class="p">],</span> <span class="n">stdin</span><span class="p">)</span>
        <span class="n">first_l</span> <span class="o">=</span> <span class="n">first_l</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="c"># For sniffers, we rstrip</span>

        <span class="n">delimiter</span> <span class="o">=</span> <span class="n">guess_delimiter</span><span class="p">(</span><span class="n">first_l</span><span class="p">)</span>
        <span class="n">headers</span>   <span class="o">=</span> <span class="n">guess_headers</span><span class="p">(</span><span class="n">first_l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">))</span>
        <span class="n">indexes</span>   <span class="o">=</span> <span class="n">guess_indexes</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">first_l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">))</span>

        <span class="n">discard_dups_r</span> <span class="o">=</span> <span class="n">DEF_DISCARD_RAW</span>
        <span class="n">discard_dups</span>   <span class="o">=</span> <span class="n">DEF_DISCARD</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SKIP</span><span class="p">:</span>
            <span class="n">delimiter</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SKIP</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;__head__&#39;</span><span class="p">:</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">next</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">SPLIT</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Reprocessing the headers with custom delimiter</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="n">guess_headers</span><span class="p">(</span><span class="n">first_l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SKIP</span><span class="p">:</span>
            <span class="n">indexes</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">SPLIT</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Reprocessing the indexes with custom headers</span>
            <span class="n">indexes</span> <span class="o">=</span> <span class="n">guess_indexes</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">first_l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SKIP</span><span class="p">:</span>
            <span class="n">discard_dups_r</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">discard_dups</span>   <span class="o">=</span> <span class="n">discard_dups_r</span> <span class="ow">in</span> <span class="n">TRUTHY</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Loading GeoBase from stdin with [sniffed] option: -i &quot;</span><span class="si">%s</span><span class="s">&quot; &quot;</span><span class="si">%s</span><span class="s">&quot; &quot;</span><span class="si">%s</span><span class="s">&quot; &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">SPLIT</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">headers</span><span class="p">),</span> <span class="n">SPLIT</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indexes</span><span class="p">),</span> <span class="n">discard_dups_r</span><span class="p">)</span>

        <span class="n">g</span> <span class="o">=</span> <span class="n">GeoBase</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s">&#39;feed&#39;</span><span class="p">,</span>
                    <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
                    <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span>
                    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                    <span class="n">indexes</span><span class="o">=</span><span class="n">indexes</span><span class="p">,</span>
                    <span class="n">discard_dups</span><span class="o">=</span><span class="n">discard_dups</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="n">warnings</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># -i options overrides default</span>
        <span class="n">add_options</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SKIP</span><span class="p">:</span>
            <span class="n">add_options</span><span class="p">[</span><span class="s">&#39;delimiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SKIP</span><span class="p">:</span>
            <span class="n">add_options</span><span class="p">[</span><span class="s">&#39;headers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">SPLIT</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SKIP</span><span class="p">:</span>
            <span class="n">add_options</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">SPLIT</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SKIP</span><span class="p">:</span>
            <span class="n">add_options</span><span class="p">[</span><span class="s">&#39;discard_dups&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="n">TRUTHY</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">add_options</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;Loading GeoBase &quot;</span><span class="si">%s</span><span class="s">&quot;...&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;base&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;Loading GeoBase &quot;</span><span class="si">%s</span><span class="s">&quot; with custom: </span><span class="si">%s</span><span class="s"> ...&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;base&#39;</span><span class="p">],</span> <span class="s">&#39; and &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">kv</span> <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="n">add_options</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>

        <span class="n">g</span> <span class="o">=</span> <span class="n">GeoBase</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;base&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">warnings</span><span class="p">,</span> <span class="o">**</span><span class="n">add_options</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">after_init</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="c"># Tuning parameters</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;exact_property&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="s">&#39;exact_property&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;__key__&#39;</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;fuzzy_property&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="s">&#39;fuzzy_property&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_field</span><span class="p">(</span><span class="n">DEF_FUZZY_FIELDS</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>

    <span class="c"># Reading map options</span>
    <span class="n">label</span>           <span class="o">=</span> <span class="n">best_field</span><span class="p">(</span><span class="n">DEF_LABEL_FIELDS</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
    <span class="n">point_size</span>      <span class="o">=</span> <span class="n">best_field</span><span class="p">(</span><span class="n">DEF_SIZE_FIELDS</span><span class="p">,</span>  <span class="n">g</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
    <span class="n">point_color</span>     <span class="o">=</span> <span class="n">best_field</span><span class="p">(</span><span class="n">DEF_COLOR_FIELDS</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
    <span class="n">icon_type</span>       <span class="o">=</span> <span class="n">DEF_ICON_TYPE</span>
    <span class="n">link_duplicates</span> <span class="o">=</span> <span class="n">DEF_LINK_DUPLICATES</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;map_data&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;map_data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SKIP</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;map_data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;map_data&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;map_data&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SKIP</span><span class="p">:</span>
        <span class="n">point_size</span> <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;map_data&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">DISABLE</span> <span class="k">else</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;map_data&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;map_data&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;map_data&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SKIP</span><span class="p">:</span>
        <span class="n">point_color</span> <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;map_data&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">DISABLE</span> <span class="k">else</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;map_data&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;map_data&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;map_data&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SKIP</span><span class="p">:</span>
        <span class="n">icon_type</span> <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;map_data&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">DISABLE</span> <span class="k">else</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;map_data&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;map_data&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;map_data&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SKIP</span><span class="p">:</span>
        <span class="n">link_duplicates</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;map_data&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="n">TRUTHY</span>

    <span class="c"># Reading quiet options</span>
    <span class="n">quiet_delimiter</span> <span class="o">=</span> <span class="n">DEF_QUIET_DELIM</span>
    <span class="n">header_display</span>  <span class="o">=</span> <span class="n">DEF_QUIET_HEADER</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;quiet_options&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;quiet_options&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SKIP</span><span class="p">:</span>
        <span class="n">quiet_delimiter</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;quiet_options&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;quiet_options&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;quiet_options&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SKIP</span><span class="p">:</span>
        <span class="n">header_display</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;quiet_options&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="c"># Reading interactive query options</span>
    <span class="n">interactive_field</span> <span class="o">=</span> <span class="n">DEF_INTER_FIELD</span>
    <span class="n">interactive_type</span>  <span class="o">=</span> <span class="n">DEF_INTER_TYPE</span>

    <span class="k">if</span> <span class="n">interactive_query_mode</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;interactive_query&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;interactive_query&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SKIP</span><span class="p">:</span>
            <span class="n">interactive_field</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;interactive_query&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;interactive_query&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;interactive_query&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SKIP</span><span class="p">:</span>
            <span class="n">interactive_type</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;interactive_query&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>



    <span class="c">#</span>
    <span class="c"># FAILING</span>
    <span class="c">#</span>
    <span class="c"># Failing on lack of opentrep support if necessary</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;trep&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">hasTrepSupport</span><span class="p">():</span>
            <span class="n">error</span><span class="p">(</span><span class="s">&#39;trep_support&#39;</span><span class="p">)</span>

    <span class="c"># Failing on lack of geocode support if necessary</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;near&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;closest&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">hasGeoSupport</span><span class="p">():</span>
            <span class="n">error</span><span class="p">(</span><span class="s">&#39;geocode_support&#39;</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>

    <span class="c"># Failing on wrong headers</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;exact&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;exact_property&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s">&#39;property&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;exact_property&#39;</span><span class="p">],</span> <span class="n">g</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;fuzzy&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;fuzzy_property&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s">&#39;property&#39;</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;fuzzy_property&#39;</span><span class="p">],</span> <span class="n">g</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>

    <span class="c"># Failing on unknown fields</span>
    <span class="n">fields_to_test</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">point_size</span><span class="p">,</span> <span class="n">point_color</span><span class="p">,</span> <span class="n">interactive_field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;show&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;omit&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">fields_to_test</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">REF</span><span class="p">]</span> <span class="o">+</span> <span class="n">g</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s">&#39;field&#39;</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="p">[</span><span class="n">REF</span><span class="p">]</span> <span class="o">+</span> <span class="n">g</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>

    <span class="c"># Testing icon_type from -M</span>
    <span class="k">if</span> <span class="n">icon_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLOWED_ICON_TYPES</span><span class="p">:</span>
        <span class="n">error</span><span class="p">(</span><span class="s">&#39;wrong_value&#39;</span><span class="p">,</span> <span class="n">icon_type</span><span class="p">,</span> <span class="n">ALLOWED_ICON_TYPES</span><span class="p">)</span>

    <span class="c"># Testing -I option</span>
    <span class="k">if</span> <span class="n">interactive_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLOWED_INTER_TYPES</span><span class="p">:</span>
        <span class="n">error</span><span class="p">(</span><span class="s">&#39;wrong_value&#39;</span><span class="p">,</span> <span class="n">interactive_type</span><span class="p">,</span> <span class="n">ALLOWED_INTER_TYPES</span><span class="p">)</span>



    <span class="c">#</span>
    <span class="c"># MAIN</span>
    <span class="c">#</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stdin</span><span class="o">.</span><span class="n">isatty</span><span class="p">()</span> <span class="ow">and</span> <span class="n">interactive_query_mode</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Looking for matches from stdin query...&#39;</span>
        <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;keys&#39;</span><span class="p">]:</span>
            <span class="k">print</span> <span class="s">&#39;Looking for matches from </span><span class="si">%s</span><span class="s">...&#39;</span> <span class="o">%</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;keys&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Looking for matches from *all* data...&#39;</span>

    <span class="c"># Keeping track of last filter applied</span>
    <span class="n">last</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c"># Keeping only keys in intermediate search</span>
    <span class="n">ex_keys</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">res</span> <span class="p">:</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">res</span><span class="p">)</span>

    <span class="c"># We start from either all keys available or keys listed by user</span>
    <span class="c"># or from stdin if there is input</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">stdin</span><span class="o">.</span><span class="n">isatty</span><span class="p">()</span> <span class="ow">and</span> <span class="n">interactive_query_mode</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">stdin</span><span class="p">]</span>
        <span class="c"># Query type</span>
        <span class="k">if</span> <span class="n">interactive_type</span> <span class="o">==</span> <span class="s">&#39;__exact__&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">interactive_field</span> <span class="o">==</span> <span class="s">&#39;__key__&#39;</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">conditions</span> <span class="o">=</span> <span class="p">[(</span><span class="n">interactive_field</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">getKeysWhere</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">force_str</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;or&#39;</span><span class="p">))</span>
                <span class="n">last</span> <span class="o">=</span> <span class="s">&#39;exact&#39;</span>

        <span class="k">elif</span> <span class="n">interactive_type</span> <span class="o">==</span> <span class="s">&#39;__fuzzy__&#39;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">fuzzyGet</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">interactive_field</span><span class="p">,</span> <span class="n">min_match</span><span class="o">=</span><span class="n">DEF_INTER_FUZZY_L</span><span class="p">)))</span>
            <span class="n">last</span> <span class="o">=</span> <span class="s">&#39;fuzzy&#39;</span>

    <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;keys&#39;</span><span class="p">]:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;keys&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>

    <span class="c"># We are going to chain conditions</span>
    <span class="c"># res will hold intermediate results</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;trep&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="s">&#39;trep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;trep&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Applying opentrep on &quot;</span><span class="si">%s</span><span class="s">&quot; [output </span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;trep&#39;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;trep_format&#39;</span><span class="p">])</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">trepGet</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;trep&#39;</span><span class="p">],</span> <span class="n">trep_format</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;trep_format&#39;</span><span class="p">],</span> <span class="n">from_keys</span><span class="o">=</span><span class="n">ex_keys</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">last</span> <span class="o">=</span> <span class="s">&#39;trep&#39;</span>


    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;exact&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="s">&#39;exact&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;exact&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;reverse&#39;</span><span class="p">]:</span>
                <span class="k">print</span> <span class="s">&#39;Applying property </span><span class="si">%s</span><span class="s"> != &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;exact_property&#39;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;exact&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;Applying property </span><span class="si">%s</span><span class="s"> == &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;exact_property&#39;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;exact&#39;</span><span class="p">])</span>

        <span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">getKeysWhere</span><span class="p">([(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;exact_property&#39;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;exact&#39;</span><span class="p">])],</span>
                                            <span class="n">from_keys</span><span class="o">=</span><span class="n">ex_keys</span><span class="p">(</span><span class="n">res</span><span class="p">),</span>
                                            <span class="n">reverse</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;reverse&#39;</span><span class="p">],</span>
                                            <span class="n">force_str</span><span class="o">=</span><span class="bp">True</span><span class="p">)))</span>
        <span class="n">last</span> <span class="o">=</span> <span class="s">&#39;exact&#39;</span>


    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;near&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="s">&#39;near&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;near&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Applying near </span><span class="si">%s</span><span class="s"> km from &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;near_limit&#39;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;near&#39;</span><span class="p">])</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="n">scan_coords</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;near&#39;</span><span class="p">],</span> <span class="n">g</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">findNearPoint</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;near_limit&#39;</span><span class="p">],</span> <span class="n">grid</span><span class="o">=</span><span class="n">with_grid</span><span class="p">,</span> <span class="n">from_keys</span><span class="o">=</span><span class="n">ex_keys</span><span class="p">(</span><span class="n">res</span><span class="p">)))</span>
        <span class="n">last</span> <span class="o">=</span> <span class="s">&#39;near&#39;</span>


    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;closest&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="s">&#39;closest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;closest&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Applying closest </span><span class="si">%s</span><span class="s"> from &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;closest_limit&#39;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;closest&#39;</span><span class="p">])</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="n">scan_coords</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;closest&#39;</span><span class="p">],</span> <span class="n">g</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">findClosestFromPoint</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;closest_limit&#39;</span><span class="p">],</span> <span class="n">grid</span><span class="o">=</span><span class="n">with_grid</span><span class="p">,</span> <span class="n">from_keys</span><span class="o">=</span><span class="n">ex_keys</span><span class="p">(</span><span class="n">res</span><span class="p">)))</span>
        <span class="n">last</span> <span class="o">=</span> <span class="s">&#39;closest&#39;</span>


    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;fuzzy&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="s">&#39;fuzzy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;fuzzy&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Applying property </span><span class="si">%s</span><span class="s"> ~= &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;fuzzy_property&#39;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;fuzzy&#39;</span><span class="p">])</span>

        <span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">fuzzyGet</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;fuzzy&#39;</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;fuzzy_property&#39;</span><span class="p">],</span> <span class="n">min_match</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;fuzzy_limit&#39;</span><span class="p">],</span> <span class="n">from_keys</span><span class="o">=</span><span class="n">ex_keys</span><span class="p">(</span><span class="n">res</span><span class="p">)))</span>
        <span class="n">last</span> <span class="o">=</span> <span class="s">&#39;fuzzy&#39;</span>


    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&#39;Done in </span><span class="si">%s</span><span class="s"> = (load) </span><span class="si">%s</span><span class="s"> + (search) </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">before_init</span><span class="p">,</span> <span class="n">after_init</span> <span class="o">-</span> <span class="n">before_init</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">after_init</span><span class="p">)</span>


    <span class="c">#</span>
    <span class="c"># DISPLAY</span>
    <span class="c">#</span>

    <span class="c"># Saving to list</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="c"># Removing unknown keys</span>
    <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">g</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s">&#39;key&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">_source</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">[(</span><span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">g</span><span class="p">]</span>


    <span class="c"># Keeping only &quot;limit&quot; first results</span>
    <span class="n">nb_res_ini</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>

    <span class="n">nb_res</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;Keeping </span><span class="si">%s</span><span class="s"> result(s) from </span><span class="si">%s</span><span class="s"> initially...&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nb_res</span><span class="p">,</span> <span class="n">nb_res_ini</span><span class="p">)</span>


    <span class="c"># Highlighting some rows</span>
    <span class="n">important</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s">&#39;__key__&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;exact&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">important</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;exact_property&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;fuzzy&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">important</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;fuzzy_property&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">interactive_query_mode</span><span class="p">:</span>
        <span class="n">important</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">interactive_field</span><span class="p">)</span>

    <span class="c"># reference may be different thing depending on the last filter</span>
    <span class="k">if</span> <span class="n">last</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;near&#39;</span><span class="p">,</span> <span class="s">&#39;closest&#39;</span><span class="p">]:</span>
        <span class="n">ref_type</span> <span class="o">=</span> <span class="s">&#39;distance&#39;</span>
    <span class="k">elif</span> <span class="n">last</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;trep&#39;</span><span class="p">,</span> <span class="s">&#39;fuzzy&#39;</span><span class="p">]:</span>
        <span class="n">ref_type</span> <span class="o">=</span> <span class="s">&#39;percentage&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ref_type</span> <span class="o">=</span> <span class="s">&#39;index&#39;</span>

    <span class="c"># Display</span>
    <span class="k">if</span> <span class="n">frontend</span> <span class="o">==</span> <span class="s">&#39;map&#39;</span><span class="p">:</span>
        <span class="n">templates</span><span class="p">,</span> <span class="n">max_t</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">_data</span><span class="p">,</span>
                                       <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                       <span class="n">point_size</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span>
                                       <span class="n">point_color</span><span class="o">=</span><span class="n">point_color</span><span class="p">,</span>
                                       <span class="n">icon_type</span><span class="o">=</span><span class="n">icon_type</span><span class="p">,</span>
                                       <span class="n">from_keys</span><span class="o">=</span><span class="n">ex_keys</span><span class="p">(</span><span class="n">res</span><span class="p">),</span>
                                       <span class="n">link_duplicates</span><span class="o">=</span><span class="n">link_duplicates</span><span class="p">,</span>
                                       <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">templates</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">display_browser</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">nb_res</span><span class="p">)</span>
            <span class="n">launch_http_server</span><span class="p">(</span><span class="n">ADDRESS</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">templates</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_t</span><span class="p">:</span>
            <span class="c"># At least one html not rendered</span>
            <span class="n">frontend</span> <span class="o">=</span> <span class="s">&#39;terminal&#39;</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">[:</span><span class="n">DEF_NUM_COL</span><span class="p">]</span>

            <span class="k">print</span> <span class="s">&#39;/!\ </span><span class="si">%s</span><span class="s"> template(s) not rendered. Switching to terminal frontend...&#39;</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="n">max_t</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">templates</span><span class="p">))</span>


    <span class="c"># We protect the stdout.write against the IOError</span>
    <span class="k">if</span> <span class="n">frontend</span> <span class="o">==</span> <span class="s">&#39;terminal&#39;</span><span class="p">:</span>
        <span class="n">display</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;omit&#39;</span><span class="p">]),</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;show&#39;</span><span class="p">],</span> <span class="n">important</span><span class="p">,</span> <span class="n">ref_type</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">frontend</span> <span class="o">==</span> <span class="s">&#39;quiet&#39;</span><span class="p">:</span>
        <span class="n">display_quiet</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s">&#39;omit&#39;</span><span class="p">]),</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;show&#39;</span><span class="p">],</span> <span class="n">ref_type</span><span class="p">,</span> <span class="n">quiet_delimiter</span><span class="p">,</span> <span class="n">header_display</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">warn_msg</span> <span class="ow">in</span> <span class="n">ENV_WARNINGS</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">dedent</span><span class="p">(</span><span class="n">warn_msg</span><span class="p">),</span>


</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">GeoBases 4 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Alex Prengere.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>