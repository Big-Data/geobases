

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>GeoBases.GeoBaseModule &mdash; GeoBases 4 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="GeoBases 4 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">GeoBases 4 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for GeoBases.GeoBaseModule</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/python</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module is a general class *GeoBase* to manipulate geographical</span>
<span class="sd">data. It loads static csv files containing data about</span>
<span class="sd">airports or train stations, and then provides tools to browse it.</span>

<span class="sd">It relies on three other modules:</span>

<span class="sd">- *GeoUtils*: to compute haversine distances between points</span>
<span class="sd">- *LevenshteinUtils*: to calculate distances between strings. Indeed, we need</span>
<span class="sd">  a good tool to do it, in order to recognize things like station names</span>
<span class="sd">  in schedule files where we do not have the station id</span>
<span class="sd">- *GeoGridModule*: to handle geographical indexation</span>

<span class="sd">Examples for airports::</span>

<span class="sd">    &gt;&gt;&gt; geo_a = GeoBase(data=&#39;airports&#39;, verbose=False)</span>
<span class="sd">    &gt;&gt;&gt; sorted(geo_a.findNearKey(&#39;ORY&#39;, 50)) # Orly, airports &lt;= 50km</span>
<span class="sd">    [(0.0, &#39;ORY&#39;), (18.8..., &#39;TNF&#39;), (27.8..., &#39;LBG&#39;), (34.8..., &#39;CDG&#39;)]</span>
<span class="sd">    &gt;&gt;&gt; geo_a.get(&#39;CDG&#39;, &#39;city_code&#39;)</span>
<span class="sd">    &#39;PAR&#39;</span>
<span class="sd">    &gt;&gt;&gt; geo_a.distance(&#39;CDG&#39;, &#39;NCE&#39;)</span>
<span class="sd">    694.5162...</span>


<span class="sd">Examples for stations::</span>

<span class="sd">    &gt;&gt;&gt; geo_t = GeoBase(data=&#39;stations&#39;, verbose=False)</span>
<span class="sd">    &gt;&gt;&gt;</span>
<span class="sd">    &gt;&gt;&gt; # Nice, stations &lt;= 5km</span>
<span class="sd">    &gt;&gt;&gt; [geo_t.get(k, &#39;name&#39;) for d, k in sorted(geo_t.findNearPoint((43.70, 7.26), 5))]</span>
<span class="sd">    [&#39;Nice-Ville&#39;, &#39;Nice-Riquier&#39;, &#39;Nice-St-Roch&#39;, &#39;Villefranche-sur-Mer&#39;, &#39;Nice-St-Augustin&#39;]</span>
<span class="sd">    &gt;&gt;&gt;</span>
<span class="sd">    &gt;&gt;&gt; geo_t.get(&#39;frpaz&#39;, &#39;name&#39;)</span>
<span class="sd">    &#39;Paris-Austerlitz&#39;</span>
<span class="sd">    &gt;&gt;&gt; geo_t.distance(&#39;frnic&#39;, &#39;frpaz&#39;)</span>
<span class="sd">    683.526...</span>

<span class="sd">From any point of reference:</span>

<span class="sd">    &gt;&gt;&gt; geo = GeoBase(data=&#39;ori_por_multi&#39;) # we have a few duplicates even with (iata, loc_type) key</span>
<span class="sd">    /!\ [lno ...] RDU+CA is duplicated #1, first found lno ...</span>
<span class="sd">    /!\ [lno ...] RDU+CA is duplicated #2, first found lno ...</span>
<span class="sd">    /!\ [lno ...] RDU+CA is duplicated #3, first found lno ...</span>
<span class="sd">    Import successful from ...</span>
<span class="sd">    Available fields for things: ...</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="kn">as</span> <span class="nn">op</span>
<span class="kn">import</span> <span class="nn">heapq</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">izip_longest</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">copy</span>

<span class="c"># Not in standard library</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="kn">from</span> <span class="nn">.GeoUtils</span>         <span class="kn">import</span> <span class="n">haversine</span>
<span class="kn">from</span> <span class="nn">.LevenshteinUtils</span> <span class="kn">import</span> <span class="n">mod_leven</span><span class="p">,</span> <span class="n">clean</span>
<span class="kn">from</span> <span class="nn">.GeoGridModule</span>    <span class="kn">import</span> <span class="n">GeoGrid</span>


<span class="k">try</span><span class="p">:</span>
    <span class="c"># This wrapper will raise an ImportError</span>
    <span class="c"># if libopentrep cannot be found</span>
    <span class="c"># or if OpenTrepWrapper was not installed</span>
    <span class="kn">from</span> <span class="nn">OpenTrepWrapper</span> <span class="kn">import</span> <span class="n">main_trep</span>

<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
    <span class="c"># Could not import</span>
    <span class="n">HAS_TREP_SUPPORT</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c"># No problem here</span>
    <span class="n">HAS_TREP_SUPPORT</span> <span class="o">=</span> <span class="bp">True</span>


<span class="c"># Relative paths handling</span>
<span class="k">def</span> <span class="nf">relative</span><span class="p">(</span><span class="n">rel_path</span><span class="p">,</span> <span class="n">root_file</span><span class="o">=</span><span class="n">__file__</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handle relative paths.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">root_file</span><span class="p">)),</span> <span class="n">rel_path</span><span class="p">)</span>


<span class="c"># Path to global configuration</span>
<span class="n">PATH_CONF</span> <span class="o">=</span> <span class="n">relative</span><span class="p">(</span><span class="s">&#39;DataSources/Sources.yaml&#39;</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">PATH_CONF</span><span class="p">)</span> <span class="k">as</span> <span class="n">fl</span><span class="p">:</span>
    <span class="n">BASES</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span>

<span class="c"># Special fields for latitude and longitude recognition</span>
<span class="n">LAT_FIELD</span>  <span class="o">=</span> <span class="s">&#39;lat&#39;</span>
<span class="n">LNG_FIELD</span>  <span class="o">=</span> <span class="s">&#39;lng&#39;</span>
<span class="n">GEO_FIELDS</span> <span class="o">=</span> <span class="p">(</span><span class="n">LAT_FIELD</span><span class="p">,</span> <span class="n">LNG_FIELD</span><span class="p">)</span>

<span class="c"># Loading indicator</span>
<span class="n">NB_LINES_STEP</span> <span class="o">=</span> <span class="mi">100000</span>

<span class="c"># Assets for map and tables</span>
<span class="n">ASSETS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;map&#39;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;template&#39;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="c"># source : v_target</span>
            <span class="n">relative</span><span class="p">(</span><span class="s">&#39;MapAssets/template.html&#39;</span><span class="p">)</span> <span class="p">:</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">_map.html&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s">&#39;static&#39;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="c"># source : target</span>
            <span class="n">relative</span><span class="p">(</span><span class="s">&#39;MapAssets/map.js&#39;</span><span class="p">)</span>            <span class="p">:</span> <span class="s">&#39;map.js&#39;</span><span class="p">,</span>
            <span class="n">relative</span><span class="p">(</span><span class="s">&#39;MapAssets/point.png&#39;</span><span class="p">)</span>         <span class="p">:</span> <span class="s">&#39;point.png&#39;</span><span class="p">,</span>
            <span class="n">relative</span><span class="p">(</span><span class="s">&#39;MapAssets/marker.png&#39;</span><span class="p">)</span>        <span class="p">:</span> <span class="s">&#39;marker.png&#39;</span><span class="p">,</span>
            <span class="n">relative</span><span class="p">(</span><span class="s">&#39;MapAssets/red_point.png&#39;</span><span class="p">)</span>     <span class="p">:</span> <span class="s">&#39;red_point.png&#39;</span><span class="p">,</span>
            <span class="n">relative</span><span class="p">(</span><span class="s">&#39;MapAssets/red_marker.png&#39;</span><span class="p">)</span>    <span class="p">:</span> <span class="s">&#39;red_marker.png&#39;</span><span class="p">,</span>
            <span class="n">relative</span><span class="p">(</span><span class="s">&#39;MapAssets/orange_point.png&#39;</span><span class="p">)</span>  <span class="p">:</span> <span class="s">&#39;orange_point.png&#39;</span><span class="p">,</span>
            <span class="n">relative</span><span class="p">(</span><span class="s">&#39;MapAssets/orange_marker.png&#39;</span><span class="p">)</span> <span class="p">:</span> <span class="s">&#39;orange_marker.png&#39;</span><span class="p">,</span>
            <span class="n">relative</span><span class="p">(</span><span class="s">&#39;MapAssets/yellow_point.png&#39;</span><span class="p">)</span>  <span class="p">:</span> <span class="s">&#39;yellow_point.png&#39;</span><span class="p">,</span>
            <span class="n">relative</span><span class="p">(</span><span class="s">&#39;MapAssets/yellow_marker.png&#39;</span><span class="p">)</span> <span class="p">:</span> <span class="s">&#39;yellow_marker.png&#39;</span><span class="p">,</span>
            <span class="n">relative</span><span class="p">(</span><span class="s">&#39;MapAssets/green_point.png&#39;</span><span class="p">)</span>   <span class="p">:</span> <span class="s">&#39;green_point.png&#39;</span><span class="p">,</span>
            <span class="n">relative</span><span class="p">(</span><span class="s">&#39;MapAssets/green_marker.png&#39;</span><span class="p">)</span>  <span class="p">:</span> <span class="s">&#39;green_marker.png&#39;</span><span class="p">,</span>
            <span class="n">relative</span><span class="p">(</span><span class="s">&#39;MapAssets/cyan_point.png&#39;</span><span class="p">)</span>    <span class="p">:</span> <span class="s">&#39;cyan_point.png&#39;</span><span class="p">,</span>
            <span class="n">relative</span><span class="p">(</span><span class="s">&#39;MapAssets/cyan_marker.png&#39;</span><span class="p">)</span>   <span class="p">:</span> <span class="s">&#39;cyan_marker.png&#39;</span><span class="p">,</span>
            <span class="n">relative</span><span class="p">(</span><span class="s">&#39;MapAssets/blue_point.png&#39;</span><span class="p">)</span>    <span class="p">:</span> <span class="s">&#39;blue_point.png&#39;</span><span class="p">,</span>
            <span class="n">relative</span><span class="p">(</span><span class="s">&#39;MapAssets/blue_marker.png&#39;</span><span class="p">)</span>   <span class="p">:</span> <span class="s">&#39;blue_marker.png&#39;</span><span class="p">,</span>
            <span class="n">relative</span><span class="p">(</span><span class="s">&#39;MapAssets/purple_point.png&#39;</span><span class="p">)</span>  <span class="p">:</span> <span class="s">&#39;purple_point.png&#39;</span><span class="p">,</span>
            <span class="n">relative</span><span class="p">(</span><span class="s">&#39;MapAssets/purple_marker.png&#39;</span><span class="p">)</span> <span class="p">:</span> <span class="s">&#39;purple_marker.png&#39;</span><span class="p">,</span>
            <span class="n">relative</span><span class="p">(</span><span class="s">&#39;MapAssets/black_point.png&#39;</span><span class="p">)</span>   <span class="p">:</span> <span class="s">&#39;black_point.png&#39;</span><span class="p">,</span>
            <span class="n">relative</span><span class="p">(</span><span class="s">&#39;MapAssets/black_marker.png&#39;</span><span class="p">)</span>  <span class="p">:</span> <span class="s">&#39;black_marker.png&#39;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s">&#39;table&#39;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;template&#39;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="c"># source : v_target</span>
            <span class="n">relative</span><span class="p">(</span><span class="s">&#39;TablesAssets/template.html&#39;</span><span class="p">)</span> <span class="p">:</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">_table.html&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s">&#39;static&#39;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="c"># source : target</span>
            <span class="n">relative</span><span class="p">(</span><span class="s">&#39;TablesAssets/table.js&#39;</span><span class="p">)</span> <span class="p">:</span> <span class="s">&#39;table.js&#39;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>



<span class="c"># We only export the main class</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;GeoBase&#39;</span><span class="p">,</span> <span class="s">&#39;BASES&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="GeoBase"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase">[docs]</a><span class="k">class</span> <span class="nc">GeoBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the main and only class. After __init__,</span>
<span class="sd">    a file is loaded in memory, and the user may use</span>
<span class="sd">    the instance to get information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="GeoBase.update"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Launch update script on data files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">script_path</span>  <span class="o">=</span> <span class="n">relative</span><span class="p">(</span><span class="s">&#39;DataSources/CheckDataUpdates.sh&#39;</span><span class="p">)</span>
        <span class="n">force_option</span> <span class="o">=</span> <span class="s">&#39;-f&#39;</span> <span class="k">if</span> <span class="n">force</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>

        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;bash </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="n">force_option</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="GeoBase.__init__"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialization</span>

<span class="sd">        The ``kwargs`` parameters given when creating the object may be:</span>

<span class="sd">        - local         : ``True`` by default, is the source local or not</span>
<span class="sd">        - source        : ``None`` by default, file-like to the source</span>
<span class="sd">        - headers       : ``[]`` by default, list of fields in the data</span>
<span class="sd">        - indexes       : ``None`` by default, list of fields defining the key for a line</span>
<span class="sd">        - delimiter     : ``&#39;^&#39;`` by default, delimiter for each field,</span>
<span class="sd">        - subdelimiters : ``{}`` by default, a ``{ &#39;field&#39; : &#39;delimiter&#39; }`` dict to define subdelimiters</span>
<span class="sd">        - quotechar     : ``&#39;&quot;&#39;`` by default, this is the string defined for quoting</span>
<span class="sd">        - limit         : ``None`` by default, put an int if you want to load only the first lines</span>
<span class="sd">        - discard_dups  : ``False`` by default, boolean to discard key duplicates of handle them</span>
<span class="sd">        - verbose       : ``True`` by default, toggle verbosity</span>

<span class="sd">        :param data: the type of data wanted, &#39;airports&#39;, &#39;stations&#39;, and many more available. \</span>
<span class="sd">            &#39;feed&#39; will create an empty instance.</span>
<span class="sd">        :param kwargs: additional parameters</span>
<span class="sd">        :raises:  ValueError, if data parameters is not recognized</span>
<span class="sd">        :returns: None</span>

<span class="sd">        &gt;&gt;&gt; geo_a = GeoBase(data=&#39;airports&#39;)</span>
<span class="sd">        Import successful from ...</span>
<span class="sd">        Available fields for things: ...</span>
<span class="sd">        &gt;&gt;&gt; geo_t = GeoBase(data=&#39;stations&#39;)</span>
<span class="sd">        Import successful from ...</span>
<span class="sd">        Available fields for things: ...</span>
<span class="sd">        &gt;&gt;&gt; geo_f = GeoBase(data=&#39;feed&#39;)</span>
<span class="sd">        Source was None, skipping loading...</span>
<span class="sd">        &gt;&gt;&gt; geo_c = GeoBase(data=&#39;odd&#39;)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        ValueError: Wrong data type. Not in [&#39;airlines&#39;, ...]</span>
<span class="sd">        &gt;&gt;&gt; </span>
<span class="sd">        &gt;&gt;&gt; fl = open(relative(&#39;DataSources/Airports/GeoNames/airports_geonames_only_clean.csv&#39;))</span>
<span class="sd">        &gt;&gt;&gt; GeoBase(data=&#39;feed&#39;,</span>
<span class="sd">        ...         source=fl,</span>
<span class="sd">        ...         headers=[&#39;iata_code&#39;, &#39;name&#39;, &#39;city&#39;],</span>
<span class="sd">        ...         indexes=&#39;iata_code&#39;,</span>
<span class="sd">        ...         delimiter=&#39;^&#39;,</span>
<span class="sd">        ...         verbose=False).get(&#39;ORY&#39;)</span>
<span class="sd">        {&#39;city&#39;: &#39;PAR&#39;, &#39;name&#39;: &#39;Paris-Orly&#39;, &#39;iata_code&#39;: &#39;ORY&#39;, &#39;__gar__&#39;: &#39;FR^France^48.7252780^2.3594440&#39;, &#39;__par__&#39;: [], &#39;__dup__&#39;: [], &#39;__key__&#39;: &#39;ORY&#39;, &#39;__lno__&#39;: 798}</span>
<span class="sd">        &gt;&gt;&gt; fl.close()</span>
<span class="sd">        &gt;&gt;&gt; GeoBase(data=&#39;airports&#39;,</span>
<span class="sd">        ...         headers=[&#39;iata_code&#39;, &#39;name&#39;, &#39;city&#39;],</span>
<span class="sd">        ...         verbose=False).get(&#39;ORY&#39;)</span>
<span class="sd">        {&#39;city&#39;: &#39;PAR&#39;, &#39;name&#39;: &#39;Paris-Orly&#39;, &#39;iata_code&#39;: &#39;ORY&#39;, &#39;__gar__&#39;: &#39;FR^France^48.7252780^2.3594440&#39;, &#39;__par__&#39;: [], &#39;__dup__&#39;: [], &#39;__key__&#39;: &#39;ORY&#39;, &#39;__lno__&#39;: 798}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Main structure in which everything will be loaded</span>
        <span class="c"># Dictionary of dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>   <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_things</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ggrid</span>  <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># A cache for the fuzzy searches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_fuzzy</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># An other cache if the algorithms are failing on a single</span>
        <span class="c"># example, we first look in this cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bias_cache_fuzzy</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># This will be similar as _headers, but can be modified after loading</span>
        <span class="c"># _headers is just for data loading</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Defaults</span>
        <span class="n">props</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;local&#39;</span>         <span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;source&#39;</span>        <span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="s">&#39;headers&#39;</span>       <span class="p">:</span> <span class="p">[],</span>
            <span class="s">&#39;indexes&#39;</span>       <span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="s">&#39;delimiter&#39;</span>     <span class="p">:</span> <span class="s">&#39;^&#39;</span><span class="p">,</span>
            <span class="s">&#39;subdelimiters&#39;</span> <span class="p">:</span> <span class="p">{},</span>
            <span class="s">&#39;quotechar&#39;</span>     <span class="p">:</span> <span class="s">&#39;&quot;&#39;</span><span class="p">,</span>
            <span class="s">&#39;limit&#39;</span>         <span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="s">&#39;discard_dups&#39;</span>  <span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s">&#39;verbose&#39;</span>       <span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">BASES</span><span class="p">:</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">BASES</span><span class="p">[</span><span class="n">data</span><span class="p">]</span>

            <span class="c"># File configuration overrides defaults</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">props</span><span class="p">:</span>
                    <span class="n">props</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Option &quot;</span><span class="si">%s</span><span class="s">&quot; for data &quot;</span><span class="si">%s</span><span class="s">&quot; not understood in file.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s">&#39;feed&#39;</span><span class="p">:</span>
            <span class="c"># User input defining everything</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Wrong data type. Not in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">BASES</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="c"># User input overrides default configuration</span>
        <span class="c"># or file configuration</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">props</span><span class="p">:</span>
                <span class="n">props</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Option &quot;</span><span class="si">%s</span><span class="s">&quot; not understood.&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="s">&#39;source&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="c"># &quot;local&quot; is only used for sources from configuration</span>
            <span class="c"># to have a relative path from the configuration file</span>
            <span class="k">if</span> <span class="n">props</span><span class="p">[</span><span class="s">&#39;source&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">props</span><span class="p">[</span><span class="s">&#39;local&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">props</span><span class="p">[</span><span class="s">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relative</span><span class="p">(</span><span class="n">props</span><span class="p">[</span><span class="s">&#39;source&#39;</span><span class="p">],</span> <span class="n">root_file</span><span class="o">=</span><span class="n">PATH_CONF</span><span class="p">)</span>

        <span class="c"># Final parameters affectation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local</span>         <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s">&#39;local&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_source</span>        <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s">&#39;source&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span>       <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s">&#39;headers&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indexes</span>       <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s">&#39;indexes&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delimiter</span>     <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s">&#39;delimiter&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subdelimiters</span> <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s">&#39;subdelimiters&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_quotechar</span>     <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s">&#39;quotechar&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span>         <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s">&#39;limit&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_discard_dups</span>  <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s">&#39;discard_dups&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span>       <span class="o">=</span> <span class="n">props</span><span class="p">[</span><span class="s">&#39;verbose&#39;</span><span class="p">]</span>

        <span class="c"># Loading data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configSubDelimiters</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;source&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="c"># As a keyword argument, source should be a file-like</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_loadFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Here we read the source from the configuration file</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="p">)</span> <span class="k">as</span> <span class="n">source_fl</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_loadFile</span><span class="p">(</span><span class="n">source_fl</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;Source was None, skipping loading...&#39;</span>

        <span class="c"># Grid</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasGeoSupport</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createGrid</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;No geocode support, skipping grid...&#39;</span>


</div>
    <span class="k">def</span> <span class="nf">_configSubDelimiters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Some precomputation on subdelimiters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">:</span>
            <span class="c"># If not in conf, do not sub split</span>
            <span class="k">if</span> <span class="n">h</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subdelimiters</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_subdelimiters</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="c"># Handling sub delimiter not list-embedded</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subdelimiters</span><span class="p">[</span><span class="n">h</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_subdelimiters</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_subdelimiters</span><span class="p">[</span><span class="n">h</span><span class="p">]]</span>



    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_configKeyer</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Define the function that build a line key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># It is possible to have a indexes which is a list</span>
        <span class="c"># In this case we build the key as the concatenation between</span>
        <span class="c"># the different fields</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">headers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">indexes</span><span class="p">),</span> <span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">headers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Inconsistent: headers = </span><span class="si">%s</span><span class="s"> with indexes = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> \
                             <span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">indexes</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keyer</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">row</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="s">&#39;+&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pos</span><span class="p">,</span> <span class="n">keyer</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_buildRowValues</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">delimiter</span><span class="p">,</span> <span class="n">subdelimiters</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">line_nb</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Building all data associated to this row.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Erase everything, except duplicates counter</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;__key__&#39;</span> <span class="p">:</span> <span class="n">key</span><span class="p">,</span>      <span class="c"># special field for key</span>
            <span class="s">&#39;__lno__&#39;</span> <span class="p">:</span> <span class="n">line_nb</span><span class="p">,</span>  <span class="c"># special field for line number</span>
            <span class="s">&#39;__gar__&#39;</span> <span class="p">:</span> <span class="p">[],</span>       <span class="c"># special field for garbage</span>
            <span class="s">&#39;__dup__&#39;</span> <span class="p">:</span> <span class="p">[],</span>       <span class="c"># special field for duplicates</span>
            <span class="s">&#39;__par__&#39;</span> <span class="p">:</span> <span class="p">[],</span>       <span class="c"># special field for parent</span>
        <span class="p">}</span>

        <span class="c"># headers represents the meaning of each column.</span>
        <span class="c"># Using izip_longest here will replace missing fields</span>
        <span class="c"># with empty strings &#39;&#39;</span>
        <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">izip_longest</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
            <span class="c"># if h is None, it means the conf file explicitely</span>
            <span class="c"># specified not to load the column</span>
            <span class="k">if</span> <span class="n">h</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c"># if h is an empty string, it means there was more</span>
            <span class="c"># data than the headers said, we store it in the</span>
            <span class="c"># __gar__ special field</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">h</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s">&#39;__gar__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">subdelimiters</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">@raw&#39;</span> <span class="o">%</span> <span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">recursive_split</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">subdelimiters</span><span class="p">[</span><span class="n">h</span><span class="p">])</span>

        <span class="c"># Flattening the __gar__ list</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;__gar__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">delimiter</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;__gar__&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">data</span>


    <span class="k">def</span> <span class="nf">_configReader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">csv_opt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Manually configure the reader, to bypass the limitations of csv.reader.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#quotechar = csv_opt[&#39;quotechar&#39;]</span>
        <span class="n">delimiter</span> <span class="o">=</span> <span class="n">csv_opt</span><span class="p">[</span><span class="s">&#39;delimiter&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="n">source_fl</span> <span class="p">:</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">source_fl</span><span class="p">,</span> <span class="o">**</span><span class="n">csv_opt</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;/!\ Delimiter &quot;</span><span class="si">%s</span><span class="s">&quot; was not 1-character.&#39;</span> <span class="o">%</span> <span class="n">delimiter</span>
            <span class="k">print</span> <span class="s">&#39;/!\ Fallback on custom reader, but quoting is disabled.&#39;</span>

        <span class="k">def</span> <span class="nf">_reader</span><span class="p">(</span><span class="n">source_fl</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Custom reader supporting multiple characters split.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">source_fl</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">row</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_reader</span>


    <span class="k">def</span> <span class="nf">_loadFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_fl</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load the file and feed the self._things.</span>

<span class="sd">        :param verbose: display informations or not during runtime</span>
<span class="sd">        :raises: IOError, if the source cannot be read</span>
<span class="sd">        :raises: ValueError, if duplicates are found in the source</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># We cache all variables used in the main loop</span>
        <span class="n">headers</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span>
        <span class="n">indexes</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indexes</span>
        <span class="n">delimiter</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delimiter</span>
        <span class="n">subdelimiters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subdelimiters</span>
        <span class="n">quotechar</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quotechar</span>
        <span class="n">limit</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limit</span>
        <span class="n">discard_dups</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_discard_dups</span>
        <span class="n">verbose</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span>

        <span class="n">pos</span><span class="p">,</span> <span class="n">keyer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configKeyer</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>

        <span class="c"># csv reader options</span>
        <span class="n">csv_opt</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;delimiter&#39;</span> <span class="p">:</span> <span class="n">delimiter</span><span class="p">,</span>
            <span class="s">&#39;quotechar&#39;</span> <span class="p">:</span> <span class="n">quotechar</span>
        <span class="p">}</span>

        <span class="n">_reader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configReader</span><span class="p">(</span><span class="o">**</span><span class="n">csv_opt</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">line_nb</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_reader</span><span class="p">(</span><span class="n">source_fl</span><span class="p">),</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">line_nb</span> <span class="o">%</span> <span class="n">NB_LINES_STEP</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;</span><span class="si">%-10s</span><span class="s"> lines loaded so far&#39;</span> <span class="o">%</span> <span class="n">line_nb</span>

            <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">line_nb</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&#39;Beyond limit </span><span class="si">%s</span><span class="s"> for lines loaded, stopping.&#39;</span> <span class="o">%</span> <span class="n">limit</span>
                <span class="k">break</span>

            <span class="c"># Skip comments and empty lines</span>
            <span class="c"># Comments must *start* with #, otherwise they will not be stripped</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span> <span class="ow">or</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">keyer</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&#39;/!\ Could not compute key with headers </span><span class="si">%s</span><span class="s">, indexes </span><span class="si">%s</span><span class="s"> for line </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> \
                            <span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">indexes</span><span class="p">,</span> <span class="n">line_nb</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">row_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buildRowValues</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">delimiter</span><span class="p">,</span> <span class="n">subdelimiters</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">line_nb</span><span class="p">)</span>

            <span class="c"># No duplicates ever, we will erase all data after if it is</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_data</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">discard_dups</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                    <span class="c"># We compute a new key for the duplicate</span>
                    <span class="n">d_key</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&#39;__dup__&#39;</span><span class="p">]))</span>

                    <span class="c"># We update the data with this info</span>
                    <span class="n">row_data</span><span class="p">[</span><span class="s">&#39;__key__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_key</span>
                    <span class="n">row_data</span><span class="p">[</span><span class="s">&#39;__dup__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&#39;__dup__&#39;</span><span class="p">]</span>
                    <span class="n">row_data</span><span class="p">[</span><span class="s">&#39;__par__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>

                    <span class="c"># We add the d_key as a new duplicate, and store the duplicate in the main _things</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&#39;__dup__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d_key</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">[</span><span class="n">d_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_data</span>

                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&quot;/!\ [lno </span><span class="si">%s</span><span class="s">] </span><span class="si">%s</span><span class="s"> is duplicated #</span><span class="si">%s</span><span class="s">, first found lno </span><span class="si">%s</span><span class="s">: creation of </span><span class="si">%s</span><span class="s">...&quot;</span> <span class="o">%</span> \
                                <span class="p">(</span><span class="n">line_nb</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&#39;__dup__&#39;</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&#39;__lno__&#39;</span><span class="p">],</span> <span class="n">d_key</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&quot;/!\ [lno </span><span class="si">%s</span><span class="s">] </span><span class="si">%s</span><span class="s"> is duplicated, first found lno </span><span class="si">%s</span><span class="s">: dropping line...&quot;</span> <span class="o">%</span> \
                                <span class="p">(</span><span class="n">line_nb</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&#39;__lno__&#39;</span><span class="p">])</span>


        <span class="c"># We remove None headers, which are not-loaded-columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;__key__&#39;</span><span class="p">,</span> <span class="s">&#39;__dup__&#39;</span><span class="p">,</span> <span class="s">&#39;__par__&#39;</span><span class="p">,</span> <span class="s">&#39;__lno__&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">subdelimiters</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">@raw&#39;</span> <span class="o">%</span> <span class="n">h</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">h</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;__gar__&#39;</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Import successful from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span>
            <span class="k">print</span> <span class="s">&quot;Available fields for things: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span>



<div class="viewcode-block" id="GeoBase.hasGeoSupport"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.hasGeoSupport">[docs]</a>    <span class="k">def</span> <span class="nf">hasGeoSupport</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if data type has geocoding support.</span>

<span class="sd">        :returns: boolean for geocoding support</span>

<span class="sd">        &gt;&gt;&gt; geo_t.hasGeoSupport()</span>
<span class="sd">        True</span>
<span class="sd">        &gt;&gt;&gt; geo_f.hasGeoSupport()</span>
<span class="sd">        False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">required</span> <span class="ow">in</span> <span class="n">GEO_FIELDS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">required</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="bp">True</span>


</div>
<div class="viewcode-block" id="GeoBase.createGrid"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.createGrid">[docs]</a>    <span class="k">def</span> <span class="nf">createGrid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the grid for geographical indexation after loading the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ggrid</span> <span class="o">=</span> <span class="n">GeoGrid</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">lat_lng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLocation</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">lat_lng</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&#39;No usable geocode for </span><span class="si">%s</span><span class="s">: (&quot;</span><span class="si">%s</span><span class="s">&quot;,&quot;</span><span class="si">%s</span><span class="s">&quot;), skipping point...&#39;</span> <span class="o">%</span> \
                            <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">LAT_FIELD</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">LNG_FIELD</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ggrid</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">lat_lng</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="GeoBase.get"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simple get on the base.</span>

<span class="sd">        This get function raises an exception when input is not correct.</span>

<span class="sd">        :param key:     the key of the thing (like &#39;SFO&#39;)</span>
<span class="sd">        :param field:   the field (like &#39;name&#39; or &#39;iata_code&#39;)</span>
<span class="sd">        :param default: if key is missing, returns default if given</span>
<span class="sd">        :raises:        KeyError, if the key is not in the base</span>
<span class="sd">        :returns:       the needed information</span>

<span class="sd">        &gt;&gt;&gt; geo_a.get(&#39;CDG&#39;, &#39;city_code&#39;)</span>
<span class="sd">        &#39;PAR&#39;</span>
<span class="sd">        &gt;&gt;&gt; geo_t.get(&#39;frnic&#39;, &#39;name&#39;)</span>
<span class="sd">        &#39;Nice-Ville&#39;</span>
<span class="sd">        &gt;&gt;&gt; geo_t.get(&#39;frnic&#39;)</span>
<span class="sd">        {&#39;info&#39;: &#39;Desserte Voyageur-Infrastructure&#39;, &#39;code&#39;: &#39;frnic&#39;, ...}</span>

<span class="sd">        Cases of unknown key.</span>

<span class="sd">        &gt;&gt;&gt; geo_t.get(&#39;frmoron&#39;, &#39;name&#39;, default=&#39;There&#39;)</span>
<span class="sd">        &#39;There&#39;</span>
<span class="sd">        &gt;&gt;&gt; geo_t.get(&#39;frmoron&#39;, &#39;name&#39;)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        KeyError: &#39;Thing not found: frmoron&#39;</span>
<span class="sd">        &gt;&gt;&gt; geo_t.get(&#39;frmoron&#39;, &#39;name&#39;, default=None)</span>
<span class="sd">        &gt;&gt;&gt; geo_t.get(&#39;frmoron&#39;, default=&#39;There&#39;)</span>
<span class="sd">        &#39;There&#39;</span>

<span class="sd">        Cases of unknown field, this is a bug and always fail.</span>

<span class="sd">        &gt;&gt;&gt; geo_t.get(&#39;frnic&#39;, &#39;not_a_field&#39;, default=&#39;There&#39;)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        KeyError: &quot;Field &#39;not_a_field&#39; [for key &#39;frnic&#39;] not in [&#39;info&#39;, &#39;code&#39;, &#39;name&#39;, &#39;lines@raw&#39;, &#39;lines&#39;, &#39;__gar__&#39;, &#39;__par__&#39;, &#39;__dup__&#39;, &#39;__key__&#39;, &#39;lat&#39;, &#39;lng&#39;, &#39;__lno__&#39;]&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">:</span>
            <span class="c"># Unless default is set, we raise an Exception</span>
            <span class="k">if</span> <span class="s">&#39;default&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;default&#39;</span><span class="p">]</span>

            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&quot;Thing not found: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

        <span class="c"># Key is in geobase here</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">field</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&quot;Field &#39;</span><span class="si">%s</span><span class="s">&#39; [for key &#39;</span><span class="si">%s</span><span class="s">&#39;] not in </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span>


</div>
<div class="viewcode-block" id="GeoBase.getLocation"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.getLocation">[docs]</a>    <span class="k">def</span> <span class="nf">getLocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns geocode as (float, float) or None.</span>

<span class="sd">        :param key:     the key of the thing (like &#39;SFO&#39;)</span>
<span class="sd">        :returns:       the location, a tuple of floats (lat, lng), or None</span>

<span class="sd">        &gt;&gt;&gt; geo_a.getLocation(&#39;AGN&#39;)</span>
<span class="sd">        (57.50..., -134.585...)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">GEO_FIELDS</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c"># Decode geocode, if error, returns None</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c"># Probably means that there is not geocode support</span>
            <span class="c"># But could be that key is unkwown</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="c"># Note that TypeError would mean that the input</span>
        <span class="c"># type was not even a string, probably NoneType</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">loc</span>


</div>
<div class="viewcode-block" id="GeoBase.hasParents"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.hasParents">[docs]</a>    <span class="k">def</span> <span class="nf">hasParents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tell if a key has parents.</span>

<span class="sd">        :param key:     the key of the thing (like &#39;SFO&#39;)</span>
<span class="sd">        :returns:       the number of parents</span>

<span class="sd">        &gt;&gt;&gt; geo_o.hasParents(&#39;MRS&#39;)</span>
<span class="sd">        0</span>
<span class="sd">        &gt;&gt;&gt; geo_o.hasParents(&#39;MRS@1&#39;)</span>
<span class="sd">        1</span>
<span class="sd">        &gt;&gt;&gt; geo_o.hasParents(&#39;PAR&#39;)</span>
<span class="sd">        0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&#39;__par__&#39;</span><span class="p">])</span>

</div>
<div class="viewcode-block" id="GeoBase.hasDuplicates"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.hasDuplicates">[docs]</a>    <span class="k">def</span> <span class="nf">hasDuplicates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tell if a key has duplicates.</span>

<span class="sd">        :param key:     the key of the thing (like &#39;SFO&#39;)</span>
<span class="sd">        :returns:       the number of duplicates</span>

<span class="sd">        &gt;&gt;&gt; geo_o.hasDuplicates(&#39;MRS&#39;)</span>
<span class="sd">        1</span>
<span class="sd">        &gt;&gt;&gt; geo_o.hasDuplicates(&#39;MRS@1&#39;)</span>
<span class="sd">        1</span>
<span class="sd">        &gt;&gt;&gt; geo_o.hasDuplicates(&#39;PAR&#39;)</span>
<span class="sd">        0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&#39;__dup__&#39;</span><span class="p">])</span>


</div>
<div class="viewcode-block" id="GeoBase.getAllDuplicates"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.getAllDuplicates">[docs]</a>    <span class="k">def</span> <span class="nf">getAllDuplicates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all duplicates data, parent key included.</span>

<span class="sd">        :param key:     the key of the thing (like &#39;SFO&#39;)</span>
<span class="sd">        :param field:   the field (like &#39;name&#39; or &#39;iata_code&#39;)</span>
<span class="sd">        :returns:       the list of values for the given field iterated \</span>
<span class="sd">                on all duplicates for the key, including the key itself</span>

<span class="sd">        &gt;&gt;&gt; geo_o.getAllDuplicates(&#39;ORY&#39;, &#39;name&#39;)</span>
<span class="sd">        [&#39;Paris-Orly&#39;]</span>
<span class="sd">        &gt;&gt;&gt; geo_o.getAllDuplicates(&#39;THA&#39;, &#39;name&#39;)</span>
<span class="sd">        [&#39;Tullahoma Regional Airport/William Northern Field&#39;, &#39;Tullahoma&#39;]</span>
<span class="sd">        &gt;&gt;&gt; geo_o.getAllDuplicates(&#39;THA&#39;, &#39;__key__&#39;)</span>
<span class="sd">        [&#39;THA&#39;, &#39;THA@1&#39;]</span>
<span class="sd">        &gt;&gt;&gt; geo_o.getAllDuplicates(&#39;THA@1&#39;, &#39;__key__&#39;)</span>
<span class="sd">        [&#39;THA@1&#39;, &#39;THA&#39;]</span>
<span class="sd">        &gt;&gt;&gt; geo_o.get(&#39;THA&#39;, &#39;__dup__&#39;)</span>
<span class="sd">        [&#39;THA@1&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">:</span>
            <span class="c"># Unless default is set, we raise an Exception</span>
            <span class="k">if</span> <span class="s">&#39;default&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;default&#39;</span><span class="p">]</span>

            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&quot;Thing not found: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

        <span class="c"># Building the list of all duplicates</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&#39;__dup__&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&#39;__par__&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="c"># Key is in geobase here</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">field</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&quot;Field &#39;</span><span class="si">%s</span><span class="s">&#39; [for key &#39;</span><span class="si">%s</span><span class="s">&#39;] not in </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> \
                           <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span>


</div>
<div class="viewcode-block" id="GeoBase.getKeysWhere"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.getKeysWhere">[docs]</a>    <span class="k">def</span> <span class="nf">getKeysWhere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">from_keys</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">force_str</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;and&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get iterator of all keys with particular field.</span>

<span class="sd">        For example, if you want to know all airports in Paris.</span>

<span class="sd">        :param conditions: a list of (field, value) conditions</span>
<span class="sd">        :param reverse:    we look keys where the field is *not* the particular value</span>
<span class="sd">        :param force_str:  for the str() method before every test</span>
<span class="sd">        :param mode:       either &#39;or&#39; or &#39;and&#39;, how to handle several conditions</span>
<span class="sd">        :param from_keys:  if given, we will look for results from this iterable of keys</span>
<span class="sd">        :returns:          an iterator of matching keys</span>

<span class="sd">        &gt;&gt;&gt; list(geo_a.getKeysWhere([(&#39;city_code&#39;, &#39;PAR&#39;)]))</span>
<span class="sd">        [&#39;ORY&#39;, &#39;TNF&#39;, &#39;CDG&#39;, &#39;BVA&#39;]</span>
<span class="sd">        &gt;&gt;&gt; list(geo_o.getKeysWhere([(&#39;comment&#39;, &#39;&#39;)], reverse=True))</span>
<span class="sd">        []</span>
<span class="sd">        &gt;&gt;&gt; list(geo_o.getKeysWhere([(&#39;__dup__&#39;, &#39;[]&#39;)]))</span>
<span class="sd">        []</span>
<span class="sd">        &gt;&gt;&gt; len(list(geo_o.getKeysWhere([(&#39;__dup__&#39;, [])])))</span>
<span class="sd">        7024</span>
<span class="sd">        &gt;&gt;&gt; len(list(geo_o.getKeysWhere([(&#39;__dup__&#39;, &#39;[]&#39;)], force_str=True)))</span>
<span class="sd">        7024</span>
<span class="sd">        &gt;&gt;&gt; len(list(geo_o.getKeysWhere([(&#39;__par__&#39;, [])], reverse=True))) # Counting duplicated keys</span>
<span class="sd">        4431</span>

<span class="sd">        Testing several conditions.</span>

<span class="sd">        &gt;&gt;&gt; c_1 = [(&#39;city_code&#39;    , &#39;PAR&#39;)]</span>
<span class="sd">        &gt;&gt;&gt; c_2 = [(&#39;location_type&#39;, &#39;H&#39;  )]</span>
<span class="sd">        &gt;&gt;&gt; len(list(geo_o.getKeysWhere(c_1)))</span>
<span class="sd">        18</span>
<span class="sd">        &gt;&gt;&gt; len(list(geo_o.getKeysWhere(c_2)))</span>
<span class="sd">        91</span>
<span class="sd">        &gt;&gt;&gt; len(list(geo_o.getKeysWhere(c_1 + c_2, mode=&#39;and&#39;)))</span>
<span class="sd">        2</span>
<span class="sd">        &gt;&gt;&gt; len(list(geo_o.getKeysWhere(c_1 + c_2, mode=&#39;or&#39;)))</span>
<span class="sd">        107</span>

<span class="sd">        This works too \o/.</span>

<span class="sd">        &gt;&gt;&gt; len(list(geo_o.getKeysWhere([(&#39;city_code&#39;, &#39;PAR&#39;), (&#39;city_code&#39;, &#39;BVE&#39;)], mode=&#39;and&#39;)))</span>
<span class="sd">        0</span>
<span class="sd">        &gt;&gt;&gt; len(list(geo_o.getKeysWhere([(&#39;city_code&#39;, &#39;PAR&#39;), (&#39;city_code&#39;, &#39;BVE&#39;)], mode=&#39;or&#39;)))</span>
<span class="sd">        20</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">from_keys</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">from_keys</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c"># We set the lambda function now to avoid testing</span>
        <span class="c"># force_str and reverse at each key later</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_str</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reverse</span><span class="p">:</span>
            <span class="n">pass_one</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">force_str</span> <span class="ow">and</span> <span class="n">reverse</span><span class="p">:</span>
            <span class="n">pass_one</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">b</span>
        <span class="k">elif</span> <span class="n">force_str</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reverse</span><span class="p">:</span>
            <span class="n">pass_one</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pass_one</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

        <span class="c"># Handle and/or cases when multiple conditions</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;and&#39;</span><span class="p">:</span>
            <span class="n">pass_all</span> <span class="o">=</span> <span class="nb">all</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;or&#39;</span><span class="p">:</span>
            <span class="n">pass_all</span> <span class="o">=</span> <span class="nb">any</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;&quot;mode&quot; argument must be in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">([</span><span class="s">&#39;and&#39;</span><span class="p">,</span> <span class="s">&#39;or&#39;</span><span class="p">]))</span>


        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">from_keys</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pass_all</span><span class="p">(</span><span class="n">pass_one</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">key</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c"># This means from_keys parameters contained unknown keys</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&#39;Key </span><span class="si">%-10s</span><span class="s"> raised KeyError in getKeysWhere, moving on...&#39;</span> <span class="o">%</span> <span class="n">key</span>

</div>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stringification.</span>

<span class="sd">        &gt;&gt;&gt; str(geo_t)</span>
<span class="sd">        &#39;&lt;GeoBases.GeoBaseModule.GeoBase(stations) object at 0x...&gt;&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;&lt;GeoBases.GeoBaseModule.GeoBase(</span><span class="si">%s</span><span class="s">) object at 0x...&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>


    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns iterator of all keys in the base.</span>

<span class="sd">        :returns: the iterator of all keys</span>

<span class="sd">        &gt;&gt;&gt; list(a for a in geo_a)</span>
<span class="sd">        [&#39;AGN&#39;, &#39;AGM&#39;, &#39;AGJ&#39;, &#39;AGH&#39;, ...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test if a thing is in the base.</span>

<span class="sd">        :param key: the key of the thing to be tested</span>
<span class="sd">        :returns:   a boolean</span>

<span class="sd">        &gt;&gt;&gt; &#39;AN&#39; in geo_a</span>
<span class="sd">        False</span>
<span class="sd">        &gt;&gt;&gt; &#39;AGN&#39; in geo_a</span>
<span class="sd">        True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>


    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Testing emptiness of structure.</span>

<span class="sd">        :returns: a boolean</span>

<span class="sd">        &gt;&gt;&gt; if not geo_o: print(&#39;empty&#39;)</span>
<span class="sd">        &gt;&gt;&gt; if geo_o:     print(&#39;not empty&#39;)</span>
<span class="sd">        not empty</span>

<span class="sd">        This geo_f is actually empty.</span>

<span class="sd">        &gt;&gt;&gt; if not geo_f: print(&#39;empty&#39;)</span>
<span class="sd">        empty</span>
<span class="sd">        &gt;&gt;&gt; if geo_f:     print(&#39;not empty&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>


<div class="viewcode-block" id="GeoBase.keys"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of all keys in the base.</span>

<span class="sd">        :returns: the list of all keys</span>

<span class="sd">        &gt;&gt;&gt; geo_a.keys()</span>
<span class="sd">        [&#39;AGN&#39;, &#39;AGM&#39;, &#39;AGJ&#39;, &#39;AGH&#39;, ...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

</div>
    <span class="k">def</span> <span class="nf">_buildDistances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat_lng_ref</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the iterable of (dist, keys) of a reference</span>
<span class="sd">        lat_lng and a list of keys. Keys which have not valid</span>
<span class="sd">        geocodes will not appear in the results.</span>

<span class="sd">        &gt;&gt;&gt; list(geo_a._buildDistances((0,0), [&#39;ORY&#39;, &#39;CDG&#39;]))</span>
<span class="sd">        [(5422.74..., &#39;ORY&#39;), (5455.45..., &#39;CDG&#39;)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">lat_lng_ref</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>

            <span class="n">lat_lng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLocation</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">lat_lng</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

                <span class="k">yield</span> <span class="n">haversine</span><span class="p">(</span><span class="n">lat_lng_ref</span><span class="p">,</span> <span class="n">lat_lng</span><span class="p">),</span> <span class="n">key</span>


<div class="viewcode-block" id="GeoBase.findNearPoint"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.findNearPoint">[docs]</a>    <span class="k">def</span> <span class="nf">findNearPoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat_lng</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">from_keys</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">double_check</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of nearby things from a point (given</span>
<span class="sd">        latidude and longitude), and a radius for the search.</span>
<span class="sd">        Note that the haversine function, which compute distance</span>
<span class="sd">        at the surface of a sphere, here returns kilometers,</span>
<span class="sd">        so the radius should be in kms.</span>

<span class="sd">        :param lat_lng: the lat_lng of the point (a tuple of (lat, lng))</span>
<span class="sd">        :param radius:  the radius of the search (kilometers)</span>
<span class="sd">        :param from_keys: if None, it takes all keys in consideration, else takes from_keys \</span>
<span class="sd">            iterable of keys to perform search.</span>
<span class="sd">        :param grid:    boolean, use grid or not</span>
<span class="sd">        :param double_check: when using grid, perform an additional check on results distance, \</span>
<span class="sd">            this is useful because the grid is approximate, so the results are only as accurate \</span>
<span class="sd">            as the grid size</span>
<span class="sd">        :returns:       an iterable of (distance, key) like [(3.2, &#39;SFO&#39;), (4.5, &#39;LAX&#39;)]</span>

<span class="sd">        &gt;&gt;&gt; # Paris, airports &lt;= 50km</span>
<span class="sd">        &gt;&gt;&gt; [geo_a.get(k, &#39;name&#39;) for d, k in sorted(geo_a.findNearPoint((48.84, 2.367), 50))]</span>
<span class="sd">        [&#39;Paris-Orly&#39;, &#39;Paris-Le Bourget&#39;, &#39;Toussus-le-Noble&#39;, &#39;Paris - Charles-de-Gaulle&#39;]</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        &gt;&gt;&gt; # Nice, stations &lt;= 5km</span>
<span class="sd">        &gt;&gt;&gt; [geo_t.get(k, &#39;name&#39;) for d, k in sorted(geo_t.findNearPoint((43.70, 7.26), 5))]</span>
<span class="sd">        [&#39;Nice-Ville&#39;, &#39;Nice-Riquier&#39;, &#39;Nice-St-Roch&#39;, &#39;Villefranche-sur-Mer&#39;, &#39;Nice-St-Augustin&#39;]</span>

<span class="sd">        No grid mode.</span>

<span class="sd">        &gt;&gt;&gt; # Paris, airports &lt;= 50km</span>
<span class="sd">        &gt;&gt;&gt; [geo_a.get(k, &#39;name&#39;) for d, k in sorted(geo_a.findNearPoint((48.84, 2.367), 50, grid=False))]</span>
<span class="sd">        [&#39;Paris-Orly&#39;, &#39;Paris-Le Bourget&#39;, &#39;Toussus-le-Noble&#39;, &#39;Paris - Charles-de-Gaulle&#39;]</span>
<span class="sd">        &gt;&gt;&gt; </span>
<span class="sd">        &gt;&gt;&gt; # Nice, stations &lt;= 5km</span>
<span class="sd">        &gt;&gt;&gt; [geo_t.get(k, &#39;name&#39;) for d, k in sorted(geo_t.findNearPoint((43.70, 7.26), 5, grid=False))]</span>
<span class="sd">        [&#39;Nice-Ville&#39;, &#39;Nice-Riquier&#39;, &#39;Nice-St-Roch&#39;, &#39;Villefranche-sur-Mer&#39;, &#39;Nice-St-Augustin&#39;]</span>
<span class="sd">        &gt;&gt;&gt; </span>
<span class="sd">        &gt;&gt;&gt; # Paris, airports &lt;= 50km with from_keys input list</span>
<span class="sd">        &gt;&gt;&gt; sorted(geo_a.findNearPoint((48.84, 2.367), 50, from_keys=[&#39;ORY&#39;, &#39;CDG&#39;, &#39;BVE&#39;], grid=False))</span>
<span class="sd">        [(12.76..., &#39;ORY&#39;), (23.40..., &#39;CDG&#39;)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">from_keys</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">from_keys</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">grid</span><span class="p">:</span>
            <span class="c"># Using grid, from_keys if just a post-filter</span>
            <span class="n">from_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">from_keys</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">dist</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ggrid</span><span class="o">.</span><span class="n">findNearPoint</span><span class="p">(</span><span class="n">lat_lng</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">double_check</span><span class="p">):</span>

                <span class="k">if</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">from_keys</span><span class="p">:</span>

                    <span class="k">yield</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">thing</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">dist</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buildDistances</span><span class="p">(</span><span class="n">lat_lng</span><span class="p">,</span> <span class="n">from_keys</span><span class="p">):</span>

                <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;=</span> <span class="n">radius</span><span class="p">:</span>

                    <span class="k">yield</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">thing</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="GeoBase.findNearKey"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.findNearKey">[docs]</a>    <span class="k">def</span> <span class="nf">findNearKey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">from_keys</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">double_check</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Same as findNearPoint, except the point is given</span>
<span class="sd">        not by a lat/lng, but with its key, like ORY or SFO.</span>
<span class="sd">        We just look up in the base to retrieve lat/lng, and</span>
<span class="sd">        call findNearPoint.</span>

<span class="sd">        :param key:     the key</span>
<span class="sd">        :param radius:  the radius of the search (kilometers)</span>
<span class="sd">        :param from_keys: if None, it takes all keys in consideration, else takes from_keys \</span>
<span class="sd">            iterable of keys to perform search.</span>
<span class="sd">        :param grid:    boolean, use grid or not</span>
<span class="sd">        :param double_check: when using grid, perform an additional check on results distance, \</span>
<span class="sd">            this is useful because the grid is approximate, so the results are only as accurate \</span>
<span class="sd">            as the grid size</span>
<span class="sd">        :returns:       an iterable of (distance, key) like [(3.2, &#39;SFO&#39;), (4.5, &#39;LAX&#39;)]</span>

<span class="sd">        &gt;&gt;&gt; sorted(geo_o.findNearKey(&#39;ORY&#39;, 10)) # Orly, por &lt;= 10km</span>
<span class="sd">        [(0.0, &#39;ORY&#39;), (1.82..., &#39;JDP&#39;), (8.06..., &#39;XJY&#39;), (9.95..., &#39;QFC&#39;)]</span>
<span class="sd">        &gt;&gt;&gt; sorted(geo_a.findNearKey(&#39;ORY&#39;, 50)) # Orly, airports &lt;= 50km</span>
<span class="sd">        [(0.0, &#39;ORY&#39;), (18.8..., &#39;TNF&#39;), (27.8..., &#39;LBG&#39;), (34.8..., &#39;CDG&#39;)]</span>
<span class="sd">        &gt;&gt;&gt; sorted(geo_t.findNearKey(&#39;frnic&#39;, 5)) # Nice station, stations &lt;= 5km</span>
<span class="sd">        [(0.0, &#39;frnic&#39;), (2.2..., &#39;fr4342&#39;), (2.3..., &#39;fr5737&#39;), (4.1..., &#39;fr4708&#39;), (4.5..., &#39;fr6017&#39;)]</span>

<span class="sd">        No grid.</span>

<span class="sd">        &gt;&gt;&gt; # Orly, airports &lt;= 50km</span>
<span class="sd">        &gt;&gt;&gt; sorted(geo_a.findNearKey(&#39;ORY&#39;, 50, grid=False))</span>
<span class="sd">        [(0.0, &#39;ORY&#39;), (18.8..., &#39;TNF&#39;), (27.8..., &#39;LBG&#39;), (34.8..., &#39;CDG&#39;)]</span>
<span class="sd">        &gt;&gt;&gt; </span>
<span class="sd">        &gt;&gt;&gt; # Nice station, stations &lt;= 5km</span>
<span class="sd">        &gt;&gt;&gt; sorted(geo_t.findNearKey(&#39;frnic&#39;, 5, grid=False))</span>
<span class="sd">        [(0.0, &#39;frnic&#39;), (2.2..., &#39;fr4342&#39;), (2.3..., &#39;fr5737&#39;), (4.1..., &#39;fr4708&#39;), (4.5..., &#39;fr6017&#39;)]</span>
<span class="sd">        &gt;&gt;&gt; </span>
<span class="sd">        &gt;&gt;&gt; sorted(geo_a.findNearKey(&#39;ORY&#39;, 50, grid=False, from_keys=[&#39;ORY&#39;, &#39;CDG&#39;, &#39;SFO&#39;]))</span>
<span class="sd">        [(0.0, &#39;ORY&#39;), (34.8..., &#39;CDG&#39;)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">from_keys</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">from_keys</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">grid</span><span class="p">:</span>
            <span class="c"># Using grid, from_keys if just a post-filter</span>
            <span class="n">from_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">from_keys</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">dist</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ggrid</span><span class="o">.</span><span class="n">findNearKey</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">double_check</span><span class="p">):</span>

                <span class="k">if</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">from_keys</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">thing</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dist</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">findNearPoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getLocation</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">radius</span><span class="p">,</span> <span class="n">from_keys</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">double_check</span><span class="p">):</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">thing</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="GeoBase.findClosestFromPoint"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.findClosestFromPoint">[docs]</a>    <span class="k">def</span> <span class="nf">findClosestFromPoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat_lng</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">from_keys</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">double_check</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Concept close to findNearPoint, but here we do not</span>
<span class="sd">        look for the things radius-close to a point,</span>
<span class="sd">        we look for the closest thing from this point, given by</span>
<span class="sd">        latitude/longitude.</span>

<span class="sd">        Note that a similar implementation is done in</span>
<span class="sd">        the LocalHelper, to find efficiently N closest point</span>
<span class="sd">        in a graph, from a point (using heaps).</span>

<span class="sd">        :param lat_lng:   the lat_lng of the point (a tuple of (lat, lng))</span>
<span class="sd">        :param N:         the N closest results wanted</span>
<span class="sd">        :param from_keys: if None, it takes all keys in consideration, else takes from_keys \</span>
<span class="sd">            iterable of keys to perform findClosestFromPoint. This is useful when we have names \</span>
<span class="sd">            and have to perform a matching based on name and location (see fuzzyGetAroundLatLng).</span>
<span class="sd">        :param grid:    boolean, use grid or not</span>
<span class="sd">        :param double_check: when using grid, perform an additional check on results distance, \</span>
<span class="sd">            this is useful because the grid is approximate, so the results are only as accurate \</span>
<span class="sd">            as the grid size</span>
<span class="sd">        :returns:       an iterable of (distance, key) like [(3.2, &#39;SFO&#39;), (4.5, &#39;LAX&#39;)]</span>

<span class="sd">        &gt;&gt;&gt; list(geo_a.findClosestFromPoint((43.70, 7.26))) # Nice</span>
<span class="sd">        [(5.82..., &#39;NCE&#39;)]</span>
<span class="sd">        &gt;&gt;&gt; list(geo_a.findClosestFromPoint((43.70, 7.26), N=3)) # Nice</span>
<span class="sd">        [(5.82..., &#39;NCE&#39;), (30.28..., &#39;CEQ&#39;), (79.71..., &#39;ALL&#39;)]</span>
<span class="sd">        &gt;&gt;&gt; list(geo_t.findClosestFromPoint((43.70, 7.26), N=1)) # Nice</span>
<span class="sd">        [(0.56..., &#39;frnic&#39;)]</span>
<span class="sd">        &gt;&gt;&gt; # Corner case, from_keys empty is not used</span>
<span class="sd">        &gt;&gt;&gt; list(geo_t.findClosestFromPoint((43.70, 7.26), N=2, from_keys=()))</span>
<span class="sd">        []</span>
<span class="sd">        &gt;&gt;&gt; </span>
<span class="sd">        &gt;&gt;&gt; #from datetime import datetime</span>
<span class="sd">        &gt;&gt;&gt; #before = datetime.now()</span>
<span class="sd">        &gt;&gt;&gt; #for _ in range(100): s = geo_a.findClosestFromPoint((43.70, 7.26), N=3)</span>
<span class="sd">        &gt;&gt;&gt; #print(datetime.now() - before)</span>

<span class="sd">        No grid.</span>

<span class="sd">        &gt;&gt;&gt; list(geo_o.findClosestFromPoint((43.70, 7.26), grid=False)) # Nice</span>
<span class="sd">        [(0.60..., &#39;NCE@1&#39;)]</span>
<span class="sd">        &gt;&gt;&gt; list(geo_a.findClosestFromPoint((43.70, 7.26), grid=False)) # Nice</span>
<span class="sd">        [(5.82..., &#39;NCE&#39;)]</span>
<span class="sd">        &gt;&gt;&gt; list(geo_a.findClosestFromPoint((43.70, 7.26), N=3, grid=False)) # Nice</span>
<span class="sd">        [(5.82..., &#39;NCE&#39;), (30.28..., &#39;CEQ&#39;), (79.71..., &#39;ALL&#39;)]</span>
<span class="sd">        &gt;&gt;&gt; list(geo_t.findClosestFromPoint((43.70, 7.26), N=1, grid=False)) # Nice</span>
<span class="sd">        [(0.56..., &#39;frnic&#39;)]</span>
<span class="sd">        &gt;&gt;&gt; list(geo_t.findClosestFromPoint((43.70, 7.26), N=2, grid=False, from_keys=(&#39;frpaz&#39;, &#39;frply&#39;, &#39;frbve&#39;)))</span>
<span class="sd">        [(482.84..., &#39;frbve&#39;), (683.89..., &#39;frpaz&#39;)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">from_keys</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">from_keys</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">grid</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dist</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ggrid</span><span class="o">.</span><span class="n">findClosestFromPoint</span><span class="p">(</span><span class="n">lat_lng</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">double_check</span><span class="p">,</span> <span class="n">from_keys</span><span class="p">):</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">thing</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">iterable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buildDistances</span><span class="p">(</span><span class="n">lat_lng</span><span class="p">,</span> <span class="n">from_keys</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">dist</span><span class="p">,</span> <span class="n">thing</span> <span class="ow">in</span> <span class="n">heapq</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">thing</span><span class="p">)</span>

</div>
    <span class="k">def</span> <span class="nf">_buildRatios</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fuzzy_value</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">min_match</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the iterable of (dist, keys) of a reference</span>
<span class="sd">        fuzzy_value and a list of keys.</span>

<span class="sd">        &gt;&gt;&gt; list(geo_a._buildRatios(&#39;marseille&#39;, &#39;name&#39;, [&#39;ORY&#39;, &#39;MRS&#39;, &#39;CDG&#39;], 0.80))</span>
<span class="sd">        [(0.9..., &#39;MRS&#39;)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>

            <span class="n">r</span> <span class="o">=</span> <span class="n">mod_leven</span><span class="p">(</span><span class="n">fuzzy_value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;=</span> <span class="n">min_match</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">r</span><span class="p">,</span> <span class="n">key</span>


<div class="viewcode-block" id="GeoBase.fuzzyGet"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.fuzzyGet">[docs]</a>    <span class="k">def</span> <span class="nf">fuzzyGet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fuzzy_value</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">min_match</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">from_keys</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fuzzy searches are retrieving an information</span>
<span class="sd">        on a thing when we do not know the code.</span>
<span class="sd">        We compare the value fuzzy_value which is supposed to be a field</span>
<span class="sd">        (e.g. a city or a name), to all things we have in the base,</span>
<span class="sd">        and we output the best match.</span>
<span class="sd">        Matching is performed using Levenshtein module, with a modified</span>
<span class="sd">        version of the Lenvenshtein ratio, adapted to the type of data.</span>

<span class="sd">        Example: we look up &#39;Marseille Saint Ch.&#39; in our base</span>
<span class="sd">        and we find the corresponding code by comparing all station</span>
<span class="sd">        names with &#39;&#39;Marseille Saint Ch.&#39;&#39;.</span>

<span class="sd">        :param fuzzy_value: the value, like &#39;Marseille&#39;</span>
<span class="sd">        :param field:       the field we look into, like &#39;name&#39;</span>
<span class="sd">        :param max_results: max number of results, None means all results</span>
<span class="sd">        :param min_match:   filter out matches under this threshold</span>
<span class="sd">        :param from_keys:   if None, it takes all keys in consideration, else takes from_keys \</span>
<span class="sd">            iterable of keys to perform fuzzyGet. This is useful when we have geocodes \</span>
<span class="sd">            and have to perform a matching based on name and location (see fuzzyGetAroundLatLng).</span>
<span class="sd">        :returns:           an iterable of (distance, key) like [(0.97, &#39;SFO&#39;), (0.55, &#39;LAX&#39;)]</span>

<span class="sd">        &gt;&gt;&gt; geo_t.fuzzyGet(&#39;Marseille Charles&#39;, &#39;name&#39;)[0]</span>
<span class="sd">        (0.8..., &#39;frmsc&#39;)</span>
<span class="sd">        &gt;&gt;&gt; geo_a.fuzzyGet(&#39;paris de gaulle&#39;, &#39;name&#39;)[0]</span>
<span class="sd">        (0.78..., &#39;CDG&#39;)</span>
<span class="sd">        &gt;&gt;&gt; geo_a.fuzzyGet(&#39;paris de gaulle&#39;, &#39;name&#39;, max_results=3, min_match=0.55)</span>
<span class="sd">        [(0.78..., &#39;CDG&#39;), (0.60..., &#39;HUX&#39;), (0.57..., &#39;LBG&#39;)]</span>
<span class="sd">        &gt;&gt;&gt; geo_a.fuzzyGet(&#39;paris de gaulle&#39;, &#39;name&#39;, max_results=3, min_match=0.75)</span>
<span class="sd">        [(0.78..., &#39;CDG&#39;)]</span>

<span class="sd">        Some corner cases.</span>

<span class="sd">        &gt;&gt;&gt; geo_a.fuzzyGet(&#39;paris de gaulle&#39;, &#39;name&#39;, max_results=None)[0]</span>
<span class="sd">        (0.78..., &#39;CDG&#39;)</span>
<span class="sd">        &gt;&gt;&gt; geo_a.fuzzyGet(&#39;paris de gaulle&#39;, &#39;name&#39;, max_results=1, from_keys=[])</span>
<span class="sd">        []</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">from_keys</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># iter(self), since __iter__ is defined is equivalent to</span>
            <span class="c"># self._things.iterkeys()</span>
            <span class="n">from_keys</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c"># All &#39;intelligence&#39; is performed in the Levenshtein</span>
        <span class="c"># module just here. All we do is minimize this distance</span>
        <span class="n">iterable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buildRatios</span><span class="p">(</span><span class="n">fuzzy_value</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">from_keys</span><span class="p">,</span> <span class="n">min_match</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">max_results</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">heapq</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="n">max_results</span><span class="p">,</span> <span class="n">iterable</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="GeoBase.fuzzyGetAroundLatLng"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.fuzzyGetAroundLatLng">[docs]</a>    <span class="k">def</span> <span class="nf">fuzzyGetAroundLatLng</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat_lng</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">fuzzy_value</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">min_match</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">from_keys</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">double_check</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Same as fuzzyGet but with we search only within a radius</span>
<span class="sd">        from a geocode.</span>

<span class="sd">        :param lat_lng:     the lat_lng of the point (a tuple of (lat, lng))</span>
<span class="sd">        :param radius:      the radius of the search (kilometers)</span>
<span class="sd">        :param fuzzy_value: the value, like &#39;Marseille&#39;</span>
<span class="sd">        :param field:       the field we look into, like &#39;name&#39;</span>
<span class="sd">        :param max_results: if None, returns all, if an int, only returns the first ones</span>
<span class="sd">        :param min_match:   filter out matches under this threshold</span>
<span class="sd">        :param from_keys:   if None, it takes all keys in consideration, else takes from_keys \</span>
<span class="sd">            iterable of keys to perform search.</span>
<span class="sd">        :param grid:        boolean, use grid or not</span>
<span class="sd">        :param double_check: when using grid, perform an additional check on results distance, \</span>
<span class="sd">            this is useful because the grid is approximate, so the results are only as accurate \</span>
<span class="sd">            as the grid size</span>
<span class="sd">        :returns:           an iterable of (distance, key) like [(0.97, &#39;SFO&#39;), (0.55, &#39;LAX&#39;)]</span>

<span class="sd">        &gt;&gt;&gt; geo_a.fuzzyGet(&#39;Brussels&#39;, &#39;name&#39;, min_match=0.60)[0]</span>
<span class="sd">        (0.61..., &#39;BQT&#39;)</span>
<span class="sd">        &gt;&gt;&gt; geo_a.get(&#39;BQT&#39;, &#39;name&#39;)  # Brussels just matched on Brest!!</span>
<span class="sd">        &#39;Brest&#39;</span>
<span class="sd">        &gt;&gt;&gt; geo_a.get(&#39;BRU&#39;, &#39;name&#39;) # We wanted BRU for &#39;Bruxelles&#39;</span>
<span class="sd">        &#39;Bruxelles National&#39;</span>
<span class="sd">        &gt;&gt;&gt; </span>
<span class="sd">        &gt;&gt;&gt; # Now a request limited to a circle of 20km around BRU gives BRU</span>
<span class="sd">        &gt;&gt;&gt; geo_a.fuzzyGetAroundLatLng((50.9013890, 4.4844440), 20, &#39;Brussels&#39;, &#39;name&#39;, min_match=0.40)[0]</span>
<span class="sd">        (0.46..., &#39;BRU&#39;)</span>
<span class="sd">        &gt;&gt;&gt; </span>
<span class="sd">        &gt;&gt;&gt; # Now a request limited to some input keys</span>
<span class="sd">        &gt;&gt;&gt; geo_a.fuzzyGetAroundLatLng((50.9013890, 4.4844440), 2000, &#39;Brussels&#39;, &#39;name&#39;, max_results=1, min_match=0.30, from_keys=[&#39;CDG&#39;, &#39;ORY&#39;])</span>
<span class="sd">        [(0.33..., &#39;ORY&#39;)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">from_keys</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">from_keys</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">nearest</span> <span class="o">=</span> <span class="p">(</span> <span class="n">key</span> <span class="k">for</span> <span class="n">dist</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">findNearPoint</span><span class="p">(</span><span class="n">lat_lng</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">from_keys</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">double_check</span><span class="p">)</span> <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fuzzyGet</span><span class="p">(</span><span class="n">fuzzy_value</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">max_results</span><span class="p">,</span> <span class="n">min_match</span><span class="p">,</span> <span class="n">from_keys</span><span class="o">=</span><span class="n">nearest</span><span class="p">)</span>

</div>
    <span class="k">def</span> <span class="nf">_fuzzyGetBiased</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Same as fuzzyGet but with bias system.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bias_cache_fuzzy</span><span class="p">:</span>
            <span class="c"># If the entry is stored is our bias</span>
            <span class="c"># cache, we do not perform the fuzzy search</span>
            <span class="c"># It avoids single failure on some rare examples</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;Using bias: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bias_cache_fuzzy</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span>

        <span class="c"># If not we process and store it in the cache</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fuzzyGet</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">)</span>


<div class="viewcode-block" id="GeoBase.fuzzyGetCached"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.fuzzyGetCached">[docs]</a>    <span class="k">def</span> <span class="nf">fuzzyGetCached</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">fuzzy_value</span><span class="p">,</span>
                       <span class="n">field</span><span class="p">,</span>
                       <span class="n">max_results</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                       <span class="n">min_match</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
                       <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                       <span class="n">show_bad</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Same as fuzzyGet but with a caching and bias system.</span>

<span class="sd">        :param fuzzy_value: the value, like &#39;Marseille&#39;</span>
<span class="sd">        :param field:       the field we look into, like &#39;name&#39;</span>
<span class="sd">        :param max_results: if None, returns all, if an int, only returns the first ones</span>
<span class="sd">        :param min_match:   filter out matches under this threshold</span>
<span class="sd">        :param verbose:     display information on a certain range of similarity</span>
<span class="sd">        :param show_bad:    the range of similarity</span>
<span class="sd">        :returns:           an iterable of (distance, key) like [(0.97, &#39;SFO&#39;), (0.55, &#39;LAX&#39;)]</span>

<span class="sd">        &gt;&gt;&gt; geo_t.fuzzyGetCached(&#39;Marseille Saint Ch.&#39;, &#39;name&#39;)[0]</span>
<span class="sd">        (0.8..., &#39;frmsc&#39;)</span>
<span class="sd">        &gt;&gt;&gt; geo_a.fuzzyGetCached(&#39;paris de gaulle&#39;, &#39;name&#39;, show_bad=(0, 1))[0]</span>
<span class="sd">        [0.79]           paris+de+gaulle -&gt;   paris+charles+de+gaulle (  CDG)</span>
<span class="sd">        (0.78..., &#39;CDG&#39;)</span>
<span class="sd">        &gt;&gt;&gt; geo_a.fuzzyGetCached(&#39;paris de gaulle&#39;, &#39;name&#39;, min_match=0.60, max_results=2, show_bad=(0, 1))</span>
<span class="sd">        [0.79]           paris+de+gaulle -&gt;   paris+charles+de+gaulle (  CDG)</span>
<span class="sd">        [0.61]           paris+de+gaulle -&gt;        bahias+de+huatulco (  HUX)</span>
<span class="sd">        [(0.78..., &#39;CDG&#39;), (0.60..., &#39;HUX&#39;)]</span>

<span class="sd">        Some biasing:</span>

<span class="sd">        &gt;&gt;&gt; geo_a.biasFuzzyCache(&#39;paris de gaulle&#39;, &#39;name&#39;, None, 0.75, [(0.5, &#39;Biased result&#39;)])</span>
<span class="sd">        &gt;&gt;&gt; geo_a.fuzzyGetCached(&#39;paris de gaulle&#39;, &#39;name&#39;, max_results=None, show_bad=(0, 1))[0] # Cache there</span>
<span class="sd">        (0.78..., &#39;CDG&#39;)</span>
<span class="sd">        &gt;&gt;&gt; geo_a.clearCache()</span>
<span class="sd">        &gt;&gt;&gt; geo_a.fuzzyGetCached(&#39;paris de gaulle&#39;, &#39;name&#39;, max_results=None, min_match=0.75)</span>
<span class="sd">        Using bias: (&#39;paris+de+gaulle&#39;, &#39;name&#39;, None, 0.75)</span>
<span class="sd">        [(0.5, &#39;Biased result&#39;)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Cleaning is for keeping only useful data</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buildCacheKey</span><span class="p">(</span><span class="n">fuzzy_value</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">max_results</span><span class="p">,</span> <span class="n">min_match</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">entry</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_fuzzy</span><span class="p">:</span>

            <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fuzzyGetBiased</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_fuzzy</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span>

            <span class="c"># Debug purpose</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_debugFuzzy</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">fuzzy_value</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">show_bad</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_fuzzy</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span>


</div>
<div class="viewcode-block" id="GeoBase.biasFuzzyCache"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.biasFuzzyCache">[docs]</a>    <span class="k">def</span> <span class="nf">biasFuzzyCache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fuzzy_value</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">max_results</span><span class="p">,</span> <span class="n">min_match</span><span class="p">,</span> <span class="n">biased_result</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If algorithms for fuzzy searches are failing on a single example,</span>
<span class="sd">        it is possible to use a first cache which will block</span>
<span class="sd">        the research and force the result.</span>

<span class="sd">        :param fuzzy_value:   the value, like &#39;Marseille&#39;</span>
<span class="sd">        :param field:         the field we look into, like &#39;name&#39;</span>
<span class="sd">        :param max_results:   if None, returns all, if an int, only returns the first ones</span>
<span class="sd">        :param min_match:     filter out matches under this threshold</span>
<span class="sd">        :param biased_result: the expected result</span>
<span class="sd">        :returns:             None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Cleaning is for keeping only useful data</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buildCacheKey</span><span class="p">(</span><span class="n">fuzzy_value</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">max_results</span><span class="p">,</span> <span class="n">min_match</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_bias_cache_fuzzy</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">biased_result</span>

</div>
<div class="viewcode-block" id="GeoBase.clearCache"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.clearCache">[docs]</a>    <span class="k">def</span> <span class="nf">clearCache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear cache for fuzzy searches.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_fuzzy</span> <span class="o">=</span> <span class="p">{}</span>

</div>
<div class="viewcode-block" id="GeoBase.clearBiasCache"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.clearBiasCache">[docs]</a>    <span class="k">def</span> <span class="nf">clearBiasCache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear biasing cache for fuzzy searches.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bias_cache_fuzzy</span> <span class="o">=</span> <span class="p">{}</span>

</div>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_buildCacheKey</span><span class="p">(</span><span class="n">fuzzy_value</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">max_results</span><span class="p">,</span> <span class="n">min_match</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Key for the cache of fuzzyGet, based on parameters.</span>

<span class="sd">        &gt;&gt;&gt; geo_a._buildCacheKey(&#39;paris de gaulle&#39;, &#39;name&#39;, max_results=None, min_match=0)</span>
<span class="sd">        (&#39;paris+de+gaulle&#39;, &#39;name&#39;, None, 0)</span>
<span class="sd">        &gt;&gt;&gt; geo_a._buildCacheKey(&#39;Antibes SNCF 2&#39;, &#39;name&#39;, max_results=3, min_match=0)</span>
<span class="sd">        (&#39;antibes&#39;, &#39;name&#39;, 3, 0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;+&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">clean</span><span class="p">(</span><span class="n">fuzzy_value</span><span class="p">)),</span> <span class="n">field</span><span class="p">,</span> <span class="n">max_results</span><span class="p">,</span> <span class="n">min_match</span>


    <span class="k">def</span> <span class="nf">_debugFuzzy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">fuzzy_value</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">show_bad</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;Some debugging.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">match</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">show_bad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">show_bad</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>

                <span class="k">print</span> <span class="s">&quot;[</span><span class="si">%.2f</span><span class="s">] </span><span class="si">%25s</span><span class="s"> -&gt; </span><span class="si">%25s</span><span class="s"> (</span><span class="si">%5s</span><span class="s">)&quot;</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                     <span class="s">&#39;+&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">clean</span><span class="p">(</span><span class="n">fuzzy_value</span><span class="p">)),</span>
                     <span class="s">&#39;+&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">clean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">field</span><span class="p">))),</span>
                     <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>


<div class="viewcode-block" id="GeoBase.distance"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.distance">[docs]</a>    <span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key0</span><span class="p">,</span> <span class="n">key1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute distance between two elements.</span>

<span class="sd">        This is just a wrapper between the original haversine</span>
<span class="sd">        function, but it is probably the most used feature :)</span>

<span class="sd">        :param key0: the first key</span>
<span class="sd">        :param key1: the second key</span>
<span class="sd">        :returns:    the distance (km)</span>

<span class="sd">        &gt;&gt;&gt; geo_t.distance(&#39;frnic&#39;, &#39;frpaz&#39;)</span>
<span class="sd">        683.526...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">haversine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getLocation</span><span class="p">(</span><span class="n">key0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLocation</span><span class="p">(</span><span class="n">key1</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="GeoBase.set"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.set">[docs]</a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to manually change a value in the base.</span>

<span class="sd">        :param key:   the key we want to change a value of</span>
<span class="sd">        :param field: the concerned field, like &#39;name&#39;</span>
<span class="sd">        :param value: the new value</span>
<span class="sd">        :returns:     None</span>

<span class="sd">        &gt;&gt;&gt; geo_t.get(&#39;frnic&#39;, &#39;name&#39;)</span>
<span class="sd">        &#39;Nice-Ville&#39;</span>
<span class="sd">        &gt;&gt;&gt; geo_t.set(&#39;frnic&#39;, &#39;name&#39;, &#39;Nice Gare SNCF&#39;)</span>
<span class="sd">        &gt;&gt;&gt; geo_t.get(&#39;frnic&#39;, &#39;name&#39;)</span>
<span class="sd">        &#39;Nice Gare SNCF&#39;</span>
<span class="sd">        &gt;&gt;&gt; geo_t.set(&#39;frnic&#39;, &#39;name&#39;, &#39;Nice-Ville&#39;) # Not to mess with other tests :)</span>

<span class="sd">        We may even add new fields.</span>

<span class="sd">        &gt;&gt;&gt; geo_t.set(&#39;frnic&#39;, &#39;new_field&#39;, &#39;some_value&#39;)</span>
<span class="sd">        &gt;&gt;&gt; geo_t.get(&#39;frnic&#39;, &#39;new_field&#39;)</span>
<span class="sd">        &#39;some_value&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># If the key is not in the base,</span>
        <span class="c"># we simply add it</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c"># If the field was not referenced in the headers</span>
        <span class="c"># we add it to the headers</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="GeoBase.setWithDict"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.setWithDict">[docs]</a>    <span class="k">def</span> <span class="nf">setWithDict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Same as set method, except we perform</span>
<span class="sd">        the input with a whole dictionary.</span>

<span class="sd">        :param key:         the key we want to change a value of</span>
<span class="sd">        :param dictionary:  the dict containing the new data</span>
<span class="sd">        :returns:           None</span>

<span class="sd">        &gt;&gt;&gt; geo_f.keys()</span>
<span class="sd">        []</span>
<span class="sd">        &gt;&gt;&gt; geo_f.setWithDict(&#39;frnic&#39;, {&#39;code&#39; : &#39;frnic&#39;, &#39;name&#39;: &#39;Nice&#39;})</span>
<span class="sd">        &gt;&gt;&gt; geo_f.keys()</span>
<span class="sd">        [&#39;frnic&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="GeoBase.delete"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to manually remove a value in the base.</span>

<span class="sd">        :param key:   the key we want to delete</span>
<span class="sd">        :returns:     None</span>

<span class="sd">        &gt;&gt;&gt; data = geo_t.get(&#39;frxrn&#39;) # Output all data in one dict</span>
<span class="sd">        &gt;&gt;&gt; geo_t.delete(&#39;frxrn&#39;)</span>
<span class="sd">        &gt;&gt;&gt; geo_t.get(&#39;frxrn&#39;, &#39;name&#39;)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">        KeyError: &#39;Thing not found: frxrn&#39;</span>

<span class="sd">        How to reverse the delete if data has been stored:</span>

<span class="sd">        &gt;&gt;&gt; geo_t.setWithDict(&#39;frxrn&#39;, data)</span>
<span class="sd">        &gt;&gt;&gt; geo_t.get(&#39;frxrn&#39;, &#39;name&#39;)</span>
<span class="sd">        &#39;Redon&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_things</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="GeoBase.hasTrepSupport"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.hasTrepSupport">[docs]</a>    <span class="k">def</span> <span class="nf">hasTrepSupport</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Check if module has OpenTrep support.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">HAS_TREP_SUPPORT</span>

</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="GeoBase.trepGet"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.trepGet">[docs]</a>    <span class="k">def</span> <span class="nf">trepGet</span><span class="p">(</span><span class="n">fuzzy_value</span><span class="p">,</span> <span class="n">trep_format</span><span class="o">=</span><span class="s">&#39;S&#39;</span><span class="p">,</span> <span class="n">from_keys</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;OpenTrep integration.</span>

<span class="sd">        If not hasTrepSupport(), main_trep is not defined</span>
<span class="sd">        and trepGet will raise an exception if called.</span>

<span class="sd">        :param fuzzy_value:   the fuzzy value</span>
<span class="sd">        :param trep_format:   the format given to OpenTrep</span>
<span class="sd">        :param from_keys:     if None, it takes all keys in consideration, else takes from_keys \</span>
<span class="sd">            iterable of keys to perform search.</span>
<span class="sd">        :param verbose:       toggle verbosity</span>
<span class="sd">        :returns:             an iterable of (distance, key) like [(0.97, &#39;SFO&#39;), (0.55, &#39;LAX&#39;)]</span>

<span class="sd">        &gt;&gt;&gt; if geo_t.hasTrepSupport():</span>
<span class="sd">        ...     print geo_t.trepGet(&#39;sna francisco los agneles&#39;) # doctest: +SKIP</span>
<span class="sd">        [(31.5192, &#39;SFO&#39;), (46.284, &#39;LAX&#39;)]</span>

<span class="sd">        &gt;&gt;&gt; if geo_t.hasTrepSupport():</span>
<span class="sd">        ...     print geo_t.trepGet(&#39;sna francisco&#39;, verbose=True) # doctest: +SKIP</span>
<span class="sd">         -&gt; Raw result: SFO/31.5192</span>
<span class="sd">         -&gt; Fmt result: ([(31.5192, &#39;SFO&#39;)], &#39;&#39;)</span>
<span class="sd">        [(31.5192, &#39;SFO&#39;)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">main_trep</span><span class="p">(</span><span class="n">searchString</span><span class="o">=</span><span class="n">fuzzy_value</span><span class="p">,</span>
                      <span class="n">outputFormat</span><span class="o">=</span><span class="n">trep_format</span><span class="p">,</span>
                      <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trep_format</span> <span class="o">==</span> <span class="s">&#39;S&#39;</span><span class="p">:</span>
            <span class="c"># Only this outputFormat is handled by upper layers</span>
            <span class="k">if</span> <span class="n">from_keys</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">from_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">from_keys</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">from_keys</span><span class="p">]</span>

        <span class="c"># For all other formats we return an empty</span>
        <span class="c"># list to avoid failures</span>
        <span class="k">return</span> <span class="p">[]</span>

</div>
<div class="viewcode-block" id="GeoBase.visualize"><a class="viewcode-back" href="../../GeoBases.html#GeoBases.GeoBaseModule.GeoBase.visualize">[docs]</a>    <span class="k">def</span> <span class="nf">visualize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">output</span><span class="o">=</span><span class="s">&#39;example&#39;</span><span class="p">,</span>
                  <span class="n">label</span><span class="o">=</span><span class="s">&#39;__key__&#39;</span><span class="p">,</span>
                  <span class="n">point_size</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">point_color</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">icon_type</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">,</span>
                  <span class="n">from_keys</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">catalog</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">add_lines</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">link_duplicates</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                  <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates map and other visualizations.</span>

<span class="sd">        :param output:          set the name of the rendered files</span>
<span class="sd">        :param label:           set the field which will appear as map icons title</span>
<span class="sd">        :param point_size:      set the field defining the map icons circle size</span>
<span class="sd">        :param point_color:     set the field defining the map icons colors</span>
<span class="sd">        :icon_type:             set the global icon size, either &#39;B&#39;, &#39;S&#39; or &#39;auto&#39;</span>
<span class="sd">        :from_keys:             only display this iterable of keys if not None</span>
<span class="sd">        :param catalog:         optional color catalog to have specific colors for certain field values</span>
<span class="sd">        :param add_lines:       optional list of (key1, key2, ..., keyN) to draw additional lines</span>
<span class="sd">        :param link_duplicates: boolean toggling lines between duplicated keys feature</span>
<span class="sd">        :param verbose:         toggle verbosity</span>
<span class="sd">        :returns:               (list of templates successfully rendered, total number of templates available).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># We take the maximum verbosity between the local and global</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="ow">or</span> <span class="n">verbose</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasGeoSupport</span><span class="p">():</span>
            <span class="n">geo_support</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">geo_support</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">/!\ Could not find fields </span><span class="si">%s</span><span class="s"> in headers </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="s">&#39; and &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GEO_FIELDS</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>

        <span class="c"># Label is the field which labels the points</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;label &quot;</span><span class="si">%s</span><span class="s">&quot; not in fields </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">point_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">point_size</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;point_size &quot;</span><span class="si">%s</span><span class="s">&quot; not in fields </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">point_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">point_color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">point_color</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;point_color &quot;</span><span class="si">%s</span><span class="s">&quot; not in fields </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">point_color</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">))</span>

        <span class="c"># Optional function which gives points size</span>
        <span class="k">if</span> <span class="n">point_size</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">get_size</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">key</span><span class="p">:</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">get_size</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">point_size</span><span class="p">)</span>

        <span class="c"># Optional function which gives points size</span>
        <span class="k">if</span> <span class="n">point_color</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">get_category</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">key</span><span class="p">:</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">get_category</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">point_color</span><span class="p">)</span>

        <span class="c"># from_keys lets you have a set of keys to visualize</span>
        <span class="k">if</span> <span class="n">from_keys</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">from_keys</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c"># Storing json data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">from_keys</span><span class="p">:</span>

            <span class="n">lat_lng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLocation</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">lat_lng</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">lat_lng</span> <span class="o">=</span> <span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="s">&#39;?&#39;</span>

            <span class="n">elem</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;__key__&#39;</span> <span class="p">:</span> <span class="n">key</span><span class="p">,</span>
                <span class="s">&#39;__lab__&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">label</span><span class="p">),</span>
                <span class="s">&#39;__siz__&#39;</span> <span class="p">:</span> <span class="n">get_size</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
                <span class="s">&#39;__cat__&#39;</span> <span class="p">:</span> <span class="n">get_category</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
                <span class="s">&#39;lat&#39;</span>     <span class="p">:</span> <span class="n">lat_lng</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s">&#39;lng&#39;</span>     <span class="p">:</span> <span class="n">lat_lng</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">}</span>

            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                <span class="c"># Keeping only important fields</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                   <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;@raw&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                   <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">:</span>

                    <span class="n">elem</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span>

            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>

        <span class="c"># Icon type</span>
        <span class="k">if</span> <span class="n">icon_type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">base_icon</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">elif</span> <span class="n">icon_type</span> <span class="o">==</span> <span class="s">&#39;auto&#39;</span><span class="p">:</span>
            <span class="n">base_icon</span> <span class="o">=</span> <span class="s">&#39;marker.png&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="k">else</span> <span class="s">&#39;point.png&#39;</span>
        <span class="k">elif</span> <span class="n">icon_type</span> <span class="o">==</span> <span class="s">&#39;S&#39;</span><span class="p">:</span>
            <span class="n">base_icon</span> <span class="o">=</span> <span class="s">&#39;point.png&#39;</span>
        <span class="k">elif</span> <span class="n">icon_type</span> <span class="o">==</span> <span class="s">&#39;B&#39;</span><span class="p">:</span>
            <span class="n">base_icon</span> <span class="o">=</span> <span class="s">&#39;marker.png&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">allowed</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;auto&#39;</span><span class="p">,</span> <span class="s">&#39;S&#39;</span><span class="p">,</span> <span class="s">&#39;B&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;icon_type &quot;</span><span class="si">%s</span><span class="s">&quot; not in </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">icon_type</span><span class="p">,</span> <span class="n">allowed</span><span class="p">))</span>

        <span class="c"># Additional lines</span>
        <span class="k">if</span> <span class="n">add_lines</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">add_lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">link_duplicates</span><span class="p">:</span>
            <span class="c"># We add to add_lines all list of duplicates</span>
            <span class="c"># We keep a set of already processed &quot;master&quot; keys to avoid</span>
            <span class="c"># putting several identical lists in the json</span>
            <span class="n">done_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="s">&#39;__key__&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasParents</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                    <span class="n">mkey</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">key</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mkey</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&#39;__par__&#39;</span><span class="p">))</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasDuplicates</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mkey</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">done_keys</span><span class="p">):</span>
                    <span class="c"># mkey have some keys which are not in done_keys</span>
                    <span class="n">add_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getAllDuplicates</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&#39;__key__&#39;</span><span class="p">))</span>
                    <span class="n">done_keys</span> <span class="o">=</span> <span class="n">done_keys</span> <span class="o">|</span> <span class="n">mkey</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;* Added lines for duplicates linking, total </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">add_lines</span><span class="p">)</span>

        <span class="c"># Count the categories for coloring</span>
        <span class="n">categories</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">icon_type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># Here we are in no-icon mode, categories</span>
                <span class="c"># will be based on the entries who will have a circle</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="s">&#39;__siz__&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">cat</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="s">&#39;__cat__&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
                <span class="n">categories</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">categories</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span> <span class="o">+=</span> <span class="n">c</span>

        <span class="c"># Color repartition given biggest categories</span>
        <span class="n">colors</span>  <span class="o">=</span> <span class="p">(</span><span class="s">&#39;red&#39;</span><span class="p">,</span> <span class="s">&#39;orange&#39;</span><span class="p">,</span> <span class="s">&#39;yellow&#39;</span><span class="p">,</span> <span class="s">&#39;green&#39;</span><span class="p">,</span> <span class="s">&#39;cyan&#39;</span><span class="p">,</span> <span class="s">&#39;purple&#39;</span><span class="p">)</span>
        <span class="n">col_num</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">categories</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># c &gt; 0 makes sure we do not create a category</span>
            <span class="c"># for stuff that will not be displayed</span>
            <span class="n">nb_non_empty_cat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">categories</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">nb_non_empty_cat</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">step</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span> <span class="o">/</span> <span class="n">nb_non_empty_cat</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># All categories may be empty if not icons + not circles</span>
                <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">cat</span><span class="p">,</span> <span class="n">vol</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">categories</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">categories</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;volume&#39;</span> <span class="p">:</span> <span class="n">vol</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">cat</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># None is also the default category, when point_color is None</span>
                <span class="n">categories</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;blue&#39;</span>

            <span class="k">elif</span> <span class="n">col_num</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">):</span>
                <span class="c"># We affect the next color available</span>
                <span class="n">categories</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">col_num</span><span class="p">]</span>
                <span class="n">col_num</span> <span class="o">+=</span> <span class="n">step</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># After all colors are used, remaining categories are black</span>
                <span class="n">categories</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;black&#39;</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">icon_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">field_vol</span> <span class="o">=</span> <span class="s">&#39;volume&#39;</span>
                <span class="k">elif</span> <span class="n">point_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">field_vol</span> <span class="o">=</span> <span class="n">point_size</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">field_vol</span> <span class="o">=</span> <span class="s">&#39;(not used)&#39;</span>

                <span class="k">print</span> <span class="s">&#39;&gt; Affecting category </span><span class="si">%-8s</span><span class="s"> to color </span><span class="si">%-7s</span><span class="s"> | </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">categories</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s">&#39;color&#39;</span><span class="p">],</span> <span class="n">field_vol</span><span class="p">,</span> <span class="n">vol</span><span class="p">)</span>


        <span class="c"># catalog is a user defined color scheme</span>
        <span class="k">if</span> <span class="n">catalog</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># Default diff-friendly catalog</span>
            <span class="n">catalog</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39; &#39;</span> <span class="p">:</span> <span class="s">&#39;blue&#39;</span><span class="p">,</span>
                <span class="s">&#39;+&#39;</span> <span class="p">:</span> <span class="s">&#39;green&#39;</span><span class="p">,</span>
                <span class="s">&#39;Y&#39;</span> <span class="p">:</span> <span class="s">&#39;green&#39;</span><span class="p">,</span>
                <span class="s">&#39;-&#39;</span> <span class="p">:</span> <span class="s">&#39;red&#39;</span><span class="p">,</span>
                <span class="s">&#39;N&#39;</span> <span class="p">:</span> <span class="s">&#39;red&#39;</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">catalog</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>

                <span class="n">old_color</span> <span class="o">=</span> <span class="n">categories</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s">&#39;color&#39;</span><span class="p">]</span>
                <span class="n">new_color</span> <span class="o">=</span> <span class="n">catalog</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span>
                <span class="n">categories</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_color</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&#39;&gt; Overrides category </span><span class="si">%-8s</span><span class="s"> to color </span><span class="si">%-7s</span><span class="s"> (from </span><span class="si">%-7s</span><span class="s">)&#39;</span> <span class="o">%</span> \
                            <span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">new_color</span><span class="p">,</span> <span class="n">old_color</span><span class="p">)</span>

                <span class="c"># We test other categories to avoid duplicates in coloring</span>
                <span class="k">for</span> <span class="n">ocat</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ocat</span> <span class="o">==</span> <span class="n">cat</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">ocat_color</span> <span class="o">=</span> <span class="n">categories</span><span class="p">[</span><span class="n">ocat</span><span class="p">][</span><span class="s">&#39;color&#39;</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">ocat_color</span> <span class="o">==</span> <span class="n">new_color</span><span class="p">:</span>
                        <span class="n">categories</span><span class="p">[</span><span class="n">ocat</span><span class="p">][</span><span class="s">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_color</span>

                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="k">print</span> <span class="s">&#39;&gt; Switching category </span><span class="si">%-8s</span><span class="s"> to color </span><span class="si">%-7s</span><span class="s"> (from </span><span class="si">%-7s</span><span class="s">)&#39;</span> <span class="o">%</span> \
                                    <span class="p">(</span><span class="n">ocat</span><span class="p">,</span> <span class="n">old_color</span><span class="p">,</span> <span class="n">ocat_color</span><span class="p">)</span>


        <span class="c"># Finally, we write the colors as an element attribute</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">elem</span><span class="p">[</span><span class="s">&#39;__col__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">categories</span><span class="p">[</span><span class="n">elem</span><span class="p">[</span><span class="s">&#39;__cat__&#39;</span><span class="p">]][</span><span class="s">&#39;color&#39;</span><span class="p">]</span>


        <span class="c"># Gathering data for lines</span>
        <span class="n">data_lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">add_lines</span><span class="p">:</span>
            <span class="n">data_line</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">l_key</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">lat_lng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLocation</span><span class="p">(</span><span class="n">l_key</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">lat_lng</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">lat_lng</span> <span class="o">=</span> <span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="s">&#39;?&#39;</span>

                <span class="n">data_line</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s">&#39;__key__&#39;</span> <span class="p">:</span> <span class="n">l_key</span><span class="p">,</span>
                    <span class="s">&#39;__lab__&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">l_key</span><span class="p">,</span> <span class="n">label</span><span class="p">),</span>
                    <span class="s">&#39;lat&#39;</span>     <span class="p">:</span> <span class="n">lat_lng</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s">&#39;lng&#39;</span>     <span class="p">:</span> <span class="n">lat_lng</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">})</span>

            <span class="n">data_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_line</span><span class="p">)</span>


        <span class="c"># Dump the json geocodes</span>
        <span class="n">json_name</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.json&#39;</span> <span class="o">%</span> <span class="n">output</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_name</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
                <span class="s">&#39;meta&#39;</span>       <span class="p">:</span> <span class="p">{</span>
                    <span class="s">&#39;label&#39;</span>           <span class="p">:</span> <span class="n">label</span><span class="p">,</span>
                    <span class="s">&#39;point_size&#39;</span>      <span class="p">:</span> <span class="n">point_size</span><span class="p">,</span>
                    <span class="s">&#39;point_color&#39;</span>     <span class="p">:</span> <span class="n">point_color</span><span class="p">,</span>
                    <span class="s">&#39;icon_type&#39;</span>       <span class="p">:</span> <span class="n">icon_type</span><span class="p">,</span>
                    <span class="s">&#39;base_icon&#39;</span>       <span class="p">:</span> <span class="n">base_icon</span><span class="p">,</span>
                    <span class="s">&#39;link_duplicates&#39;</span> <span class="p">:</span> <span class="n">link_duplicates</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="s">&#39;points&#39;</span>     <span class="p">:</span> <span class="n">data</span><span class="p">,</span>
                <span class="s">&#39;lines&#39;</span>      <span class="p">:</span> <span class="n">data_lines</span><span class="p">,</span>
                <span class="s">&#39;categories&#39;</span> <span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">categories</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span>
                                      <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;volume&#39;</span><span class="p">],</span>
                                      <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="p">}))</span>

        <span class="n">tmp_template</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tmp_static</span>   <span class="o">=</span> <span class="p">[</span><span class="n">json_name</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">assets</span> <span class="ow">in</span> <span class="n">ASSETS</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="c"># We do not render the map template  if not geocodes</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;map&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">geo_support</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">template</span><span class="p">,</span> <span class="n">v_target</span> <span class="ow">in</span> <span class="n">assets</span><span class="p">[</span><span class="s">&#39;template&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">v_target</span> <span class="o">%</span> <span class="n">output</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">template</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">:</span>
                            <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;{{file_name}}&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
                            <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;{{json_file}}&#39;</span><span class="p">,</span> <span class="n">json_name</span><span class="p">)</span>
                            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

                <span class="n">tmp_template</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">assets</span><span class="p">[</span><span class="s">&#39;static&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">copy</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
                <span class="n">tmp_static</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span>
            <span class="k">print</span> <span class="s">&#39;* Now you may use your browser to visualize:&#39;</span>
            <span class="k">print</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_template</span><span class="p">)</span>
            <span class="k">print</span>
            <span class="k">print</span> <span class="s">&#39;* If you want to clean the temporary files:&#39;</span>
            <span class="k">print</span> <span class="s">&#39;rm </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_static</span> <span class="o">+</span> <span class="n">tmp_template</span><span class="p">)</span>
            <span class="k">print</span>

        <span class="c"># This is the numbered of templates rendered</span>
        <span class="k">return</span> <span class="n">tmp_template</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s">&#39;template&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ASSETS</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>


</div></div>
<span class="k">def</span> <span class="nf">ext_split</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">split</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extended split function handling None and &#39;&#39; splitter.</span>

<span class="sd">    :param value:  the value to be split</span>
<span class="sd">    :param split:  the splitter</span>
<span class="sd">    :returns:      the split value</span>

<span class="sd">    &gt;&gt;&gt; ext_split(&#39;PAR&#39;, &#39;A&#39;)</span>
<span class="sd">    (&#39;P&#39;, &#39;R&#39;)</span>
<span class="sd">    &gt;&gt;&gt; ext_split(&#39;PAR&#39;, &#39;&#39;)</span>
<span class="sd">    (&#39;P&#39;, &#39;A&#39;, &#39;R&#39;)</span>
<span class="sd">    &gt;&gt;&gt; ext_split(&#39;PAR&#39;, None)</span>
<span class="sd">    &#39;PAR&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">split</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">if</span> <span class="n">split</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
        <span class="c"># Here we convert a string like &#39;CA&#39; into (&#39;C&#39;, &#39;A&#39;)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">split</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">recursive_split</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">splits</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Recursive extended split.</span>

<span class="sd">    :param value:  the value to be split</span>
<span class="sd">    :param splits: the list of splitters</span>
<span class="sd">    :returns:      the split value</span>

<span class="sd">    &gt;&gt;&gt; recursive_split(&#39;PAR^Paris/Parys&#39;, [&#39;^&#39;, &#39;/&#39;])</span>
<span class="sd">    ((&#39;PAR&#39;,), (&#39;Paris&#39;, &#39;Parys&#39;))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Case where no subdelimiters</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">splits</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ext_split</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ext_split</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="n">ext_split</span><span class="p">(</span><span class="n">sv</span><span class="p">,</span> <span class="n">splits</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">sv</span> <span class="ow">in</span> <span class="n">ext_split</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">)</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Sub delimiter &quot;</span><span class="si">%s</span><span class="s">&quot; not supported.&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">splits</span><span class="p">))</span>



<span class="k">def</span> <span class="nf">_test</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;When called directly, launching doctests.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">doctest</span>

    <span class="n">extraglobs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;geo_o&#39;</span><span class="p">:</span> <span class="n">GeoBase</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s">&#39;ori_por&#39;</span><span class="p">,</span>  <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="s">&#39;geo_a&#39;</span><span class="p">:</span> <span class="n">GeoBase</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s">&#39;airports&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="s">&#39;geo_t&#39;</span><span class="p">:</span> <span class="n">GeoBase</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s">&#39;stations&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
        <span class="s">&#39;geo_f&#39;</span><span class="p">:</span> <span class="n">GeoBase</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s">&#39;feed&#39;</span><span class="p">,</span>     <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">opt</span> <span class="o">=</span>  <span class="p">(</span><span class="n">doctest</span><span class="o">.</span><span class="n">ELLIPSIS</span> <span class="o">|</span>
            <span class="n">doctest</span><span class="o">.</span><span class="n">NORMALIZE_WHITESPACE</span><span class="p">)</span>
            <span class="c">#doctest.REPORT_ONLY_FIRST_FAILURE)</span>
            <span class="c">#doctest.IGNORE_EXCEPTION_DETAIL)</span>

    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">(</span><span class="n">extraglobs</span><span class="o">=</span><span class="n">extraglobs</span><span class="p">,</span> <span class="n">optionflags</span><span class="o">=</span><span class="n">opt</span><span class="p">)</span>



<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">_test</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">GeoBases 4 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, OpenTravelData.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>